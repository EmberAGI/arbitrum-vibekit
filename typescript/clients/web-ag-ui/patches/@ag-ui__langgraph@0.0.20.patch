diff --git a/dist/index.d.mts b/dist/index.d.mts
index 9a8c316196a050b83b7b17e86ef0f8790d45c7a0..e8f564c5dba86cecc38caf3f6a956de046b76ebd 100644
--- a/dist/index.d.mts
+++ b/dist/index.d.mts
@@ -140,6 +140,7 @@ declare class LangGraphAgent extends AbstractAgent {
     clone(): LangGraphAgent;
     dispatchEvent(event: ProcessedEvents): boolean;
     run(input: RunAgentInput$1): Observable<ProcessedEvents>;
+    protected connect(input: RunAgentInput$1): Observable<ProcessedEvents>;
     runAgentStream(input: RunAgentExtendedInput, subscriber: Subscriber<ProcessedEvents>): Promise<void>;
     prepareRegenerateStream(input: RegenerateInput, streamMode: StreamMode | StreamMode[]): Promise<void | {
         streamResponse: _langchain_langgraph_sdk_dist_types_stream.TypedAsyncGenerator<"messages" | "values" | "updates" | "events" | "debug" | "tasks" | "checkpoints" | "custom" | "messages-tuple" | StreamMode[], false, _langchain_langgraph_sdk.DefaultValues, _langchain_langgraph_sdk.DefaultValues, unknown>;
diff --git a/dist/index.d.ts b/dist/index.d.ts
index 9a8c316196a050b83b7b17e86ef0f8790d45c7a0..e8f564c5dba86cecc38caf3f6a956de046b76ebd 100644
--- a/dist/index.d.ts
+++ b/dist/index.d.ts
@@ -140,6 +140,7 @@ declare class LangGraphAgent extends AbstractAgent {
     clone(): LangGraphAgent;
     dispatchEvent(event: ProcessedEvents): boolean;
     run(input: RunAgentInput$1): Observable<ProcessedEvents>;
+    protected connect(input: RunAgentInput$1): Observable<ProcessedEvents>;
     runAgentStream(input: RunAgentExtendedInput, subscriber: Subscriber<ProcessedEvents>): Promise<void>;
     prepareRegenerateStream(input: RegenerateInput, streamMode: StreamMode | StreamMode[]): Promise<void | {
         streamResponse: _langchain_langgraph_sdk_dist_types_stream.TypedAsyncGenerator<"messages" | "values" | "updates" | "events" | "debug" | "tasks" | "checkpoints" | "custom" | "messages-tuple" | StreamMode[], false, _langchain_langgraph_sdk.DefaultValues, _langchain_langgraph_sdk.DefaultValues, unknown>;
diff --git a/dist/index.js b/dist/index.js
index 1e21853e8578d1e5a7b3d1d10d4bca4ec8f00b61..5bd1699f95c1cd06205b6123a0d03df1b8259cb6 100644
--- a/dist/index.js
+++ b/dist/index.js
@@ -1,7 +1,7 @@
-"use strict";var j=Object.defineProperty,yt=Object.defineProperties,vt=Object.getOwnPropertyDescriptor,_t=Object.getOwnPropertyDescriptors,Tt=Object.getOwnPropertyNames,$=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,ot=Object.prototype.propertyIsEnumerable;var it=(a,n)=>(n=Symbol[a])?n:Symbol.for("Symbol."+a);var rt=(a,n,t)=>n in a?j(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,m=(a,n)=>{for(var t in n||(n={}))z.call(n,t)&&rt(a,t,n[t]);if($)for(var t of $(n))ot.call(n,t)&&rt(a,t,n[t]);return a},y=(a,n)=>yt(a,_t(n));var lt=(a,n)=>{var t={};for(var e in a)z.call(a,e)&&n.indexOf(e)<0&&(t[e]=a[e]);if(a!=null&&$)for(var e of $(a))n.indexOf(e)<0&&ot.call(a,e)&&(t[e]=a[e]);return t};var Rt=(a,n)=>{for(var t in n)j(a,t,{get:n[t],enumerable:!0})},It=(a,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of Tt(n))!z.call(a,s)&&s!==t&&j(a,s,{get:()=>n[s],enumerable:!(e=vt(n,s))||e.enumerable});return a};var Mt=a=>It(j({},"__esModule",{value:!0}),a);var ht=(a,n,t)=>(n=a[it("asyncIterator")])?n.call(a):(a=a[it("iterator")](),n={},t=(e,s)=>(s=a[e])&&(n[e]=i=>new Promise((r,g,u)=>(i=s.call(a,i),u=i.done,Promise.resolve(i.value).then(l=>r({value:l,done:u}),g)))),t("next"),t("return"),n);var Nt={};Rt(Nt,{CustomEventNames:()=>ct,LangGraphAgent:()=>tt,LangGraphEventTypes:()=>dt,LangGraphHttpAgent:()=>et});module.exports=Mt(Nt);var St=require("@ag-ui/client");var mt=require("rxjs"),ft=require("@langchain/langgraph-sdk"),V=require("@ag-ui/client");var dt=(d=>(d.OnChainStart="on_chain_start",d.OnChainStream="on_chain_stream",d.OnChainEnd="on_chain_end",d.OnChatModelStart="on_chat_model_start",d.OnChatModelStream="on_chat_model_stream",d.OnChatModelEnd="on_chat_model_end",d.OnToolStart="on_tool_start",d.OnToolEnd="on_tool_end",d.OnCustomEvent="on_custom_event",d.OnInterrupt="on_interrupt",d))(dt||{}),ct=(s=>(s.ManuallyEmitMessage="manually_emit_message",s.ManuallyEmitToolCall="manually_emit_tool_call",s.ManuallyEmitState="manually_emit_state",s.Exit="exit",s))(ct||{});var o=require("@ag-ui/client");var Q=["messages","tools"];function q(a,n){return Object.fromEntries(Object.entries(a).filter(([t])=>n.includes(t)))}function gt({mode:a,state:n,schemaKeys:t}){let e=a==="start"?n:null;return e&&(t!=null&&t.input)&&(e=q(e,[...Q,...t.input])),e}function Ct(a){var t;let n=[];for(let e of a)if(e.type==="text"&&e.text)n.push({type:"text",text:e.text});else if(e.type==="image_url"){let s=typeof e.image_url=="string"?e.image_url:(t=e.image_url)==null?void 0:t.url;if(!s)continue;if(s.startsWith("data:")){let[i,r]=s.split(",",2),g=i.includes(":")?i.split(":")[1].split(";")[0]:"image/png";n.push({type:"binary",mimeType:g,data:r||""})}else n.push({type:"binary",mimeType:"image/png",url:s})}return n}function xt(a){let n=[];for(let t of a)if(t.type==="text")n.push({type:"text",text:t.text});else if(t.type==="binary"){let e;if(t.url)e=t.url;else if(t.data)e=`data:${t.mimeType};base64,${t.data}`;else if(t.id)e=t.id;else continue;n.push({type:"image_url",image_url:{url:e}})}return n}function ut(a){return a.map(n=>{var t;switch(n.type){case"human":let e;return Array.isArray(n.content)?e=Ct(n.content):e=X(P(n.content)),{id:n.id,role:"user",content:e};case"ai":let s=P(n.content);return{id:n.id,role:"assistant",content:s?X(s):"",toolCalls:(t=n.tool_calls)==null?void 0:t.map(i=>({id:i.id,type:"function",function:{name:i.name,arguments:JSON.stringify(i.args)}}))};case"system":return{id:n.id,role:"system",content:X(P(n.content))};case"tool":return{id:n.id,role:"tool",content:X(P(n.content)),toolCallId:n.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function Z(a){return a.map((n,t)=>{var e,s;switch(n.role){case"user":let i;return typeof n.content=="string"?i=n.content:Array.isArray(n.content)?i=xt(n.content):i=String(n.content),{id:n.id,role:n.role,content:i,type:"human"};case"assistant":return{id:n.id,type:"ai",role:n.role,content:(e=n.content)!=null?e:"",tool_calls:((s=n.toolCalls)!=null?s:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:n.id,role:n.role,content:n.content,type:"system"};case"tool":return{content:n.content,role:n.role,type:n.role,tool_call_id:n.toolCallId,id:n.id};default:throw console.error(`Message role ${n.role} is not implemented`),new Error("message role is not supported.")}})}function X(a){return typeof a=="string"?a:JSON.stringify(a)}function pt(a){var t,e,s,i,r;let n=(t=a.chunk)==null?void 0:t.content;if(n&&Array.isArray(n)&&n.length&&n[0])return n[0].thinking?{text:n[0].thinking,type:"text",index:n[0].index}:null;if((i=(s=(e=a.chunk.additional_kwargs)==null?void 0:e.reasoning)==null?void 0:s.summary)!=null&&i[0]){let g=(r=a.chunk.additional_kwargs)==null?void 0:r.reasoning.summary[0];return!g||!g.text?null:{type:"text",text:g.text,index:g.index}}return null}function P(a){var n;if(!a)return null;if(typeof a=="string")return a;if(Array.isArray(a)&&a.length){let t=(n=a.find(e=>e.type==="text"))==null?void 0:n.text;return t!=null?t:null}return null}var tt=class a extends o.AbstractAgent{constructor(t){var e,s;super(t);this.cancelRequested=!1;this.cancelSent=!1;this.constantSchemaKeys=Q;this.config=t,this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(s=t==null?void 0:t.client)!=null?s:new ft.Client({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:m({},(e=t.propertyHeaders)!=null?e:{})})}clone(){return new a(this.config)}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return new mt.Observable(e=>(this.runAgentStream(t,e),()=>{}))}async runAgentStream(t,e){var g,u,l;this.activeRun={id:t.runId,threadId:t.threadId,hasFunctionStreaming:!1},this.cancelRequested=!1,this.cancelSent=!1,this.subscriber=e,this.assistant||(this.assistant=await this.getAssistant());let s=(g=t.threadId)!=null?g:(0,V.randomUUID)(),i=(l=(u=t.forwardedProps)==null?void 0:u.streamMode)!=null?l:["events","values","updates"],r=await this.prepareStream(y(m({},t),{threadId:s}),i);if(!r)return e.error("No stream to regenerate");await this.handleStreamEvents(r,s,e,t,Array.isArray(i)?i:[i])}async prepareRegenerateStream(t,e){var l,d,c;let{threadId:s,messageCheckpoint:i}=t,r=await this.getCheckpointByMessage(i.id,s);if(this.assistant||(this.assistant=await this.getAssistant()),!r)return this.subscriber.error("No checkpoint found for message");let g=await this.client.threads.updateState(s,{values:this.langGraphDefaultMergeState(r.values,[],t),checkpointId:r.checkpoint.checkpoint_id,asNode:(d=(l=r.next)==null?void 0:l[0])!=null?d:"__start__"}),u=y(m({},(c=t.forwardedProps)!=null?c:{}),{input:this.langGraphDefaultMergeState(r.values,[i],t),checkpointId:g.checkpoint.checkpoint_id,streamMode:e});return{streamResponse:this.client.runs.stream(s,this.assistant.assistant_id,u),state:r,streamMode:e}}async prepareStream(t,e){var nt,w,b,G,D,K,U,k,L,J;let{threadId:s,state:i,messages:r,tools:g,context:u,forwardedProps:l}=t;this.activeRun.manuallyEmittedState=null;let d=l==null?void 0:l.nodeName,c=s!=null?s:(0,V.randomUUID)();this.assistant||(this.assistant=await this.getAssistant());let h=await this.getOrCreateThread(c,l==null?void 0:l.threadMetadata);this.activeRun.threadId=h.thread_id;let f=(nt=await this.client.threads.getState(h.thread_id))!=null?nt:{values:{}},p=(w=f.values.messages)!=null?w:[],N=Z(r),T=this.langGraphDefaultMergeState(y(m({},i),{messages:p}),N,t),R=y(m({},f),{values:y(m({},T),{messages:[...p,...(b=T.messages)!=null?b:[]]})}),C=R.values;if(this.activeRun.schemaKeys=await this.getSchemaKeys(),((G=f.values.messages)!=null?G:[]).length>r.filter(S=>S.role!=="system").length){let S=null;for(let A=r.length-1;A>=0;A--)if(r[A].role==="user"){S=Z([r[A]])[0];break}return S?this.prepareRegenerateStream(y(m({},t),{messageCheckpoint:S}),e):this.subscriber.error("No user message found in messages to regenerate")}this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id);let v=!((D=l==null?void 0:l.command)!=null&&D.resume)&&c&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(v==="continue"){let S=this.activeRun.graphInfo.edges.find(A=>A.target===this.activeRun.nodeName);await this.client.threads.updateState(c,{values:i,asNode:S==null?void 0:S.source})}let x=gt({mode:v,state:C,schemaKeys:this.activeRun.schemaKeys}),_,F=[this.assistantConfig,l==null?void 0:l.config].filter(Boolean);F.length&&(_=await this.mergeConfigs({configs:F,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let I=y(m({},l),{streamMode:e,input:x,config:_,context:m(m({},u),(K=_==null?void 0:_.configurable)!=null?K:{})}),M=(L=(k=(U=f.tasks)==null?void 0:U[0])==null?void 0:k.interrupts)!=null?L:[];return M!=null&&M.length&&!((J=l==null?void 0:l.command)!=null&&J.resume)?(this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:c,runId:t.runId}),this.handleNodeChange(d),M.forEach(S=>{this.dispatchEvent({type:o.EventType.CUSTOM,name:"on_interrupt",value:typeof S.value=="string"?S.value:JSON.stringify(S.value),rawEvent:S})}),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:c,runId:t.runId}),this.subscriber.complete()):{streamResponse:this.client.runs.stream(c,this.assistant.assistant_id,I),state:R}}async handleStreamEvents(t,e,s,i,r){var p,N,T,R,C,v,x,_,w,b,G,D,K,U;let{forwardedProps:g}=i,u=g==null?void 0:g.nodeName;this.subscriber=s;let l=!1;if(!t)return;let{streamResponse:d,state:c}=t;this.activeRun.prevNodeName=null;let h={},f=c;try{this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:e,runId:this.activeRun.id}),this.handleNodeChange(u);try{for(var F=ht(d),I,M,nt;I=!(M=await F.next()).done;I=!1){let E=M.value;if(this.cancelRequested&&!this.cancelSent&&((p=this.activeRun)!=null&&p.threadId)&&((N=this.activeRun)!=null&&N.id)){try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}try{await((T=d==null?void 0:d.return)==null?void 0:T.call(d))}catch(W){}break}let st=(R=i.forwardedProps)==null?void 0:R.streamSubgraphs,Et=st&&(E.event.startsWith("events")||E.event.startsWith("values"));if(!r.includes(E.event)&&!Et&&E.event!=="error")continue;let H=E;if(E.event==="error"){this.dispatchEvent({type:o.EventType.RUN_ERROR,message:E.data.message,rawEvent:E});break}if(E.event==="updates")continue;if(E.event==="values"){h=H.data;continue}else if(st&&H.event.startsWith("values|")){h=m(m({},h),H.data);continue}let B=H.data,Y=(C=B.metadata)!=null?C:{},O=Y.langgraph_node,at=B.event;if(Y.run_id&&(this.activeRun.id=Y.run_id,this.activeRun.serverRunIdKnown=!0,this.cancelRequested&&!this.cancelSent&&((v=this.activeRun)!=null&&v.threadId)))try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}if(O&&O!==this.activeRun.nodeName&&this.handleNodeChange(O),l=l||at==="on_custom_event"&&B.name==="exit",at==="on_chain_end"&&this.activeRun.nodeName===O&&(this.activeRun.exitingNode=!0),this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),(x=this.activeRun.graphInfo)!=null&&x.nodes.some(W=>W.id===O)&&this.handleNodeChange(O),f.values=(_=this.activeRun.manuallyEmittedState)!=null?_:h,!this.activeRun.nodeName)continue;(JSON.stringify(f)!==JSON.stringify(c)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(c=f,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c),rawEvent:H})),this.dispatchEvent({type:o.EventType.RAW,event:B}),this.handleSingleEvent(B)}}catch(M){nt=[M]}finally{try{I&&(M=F.return)&&await M.call(F)}finally{if(nt)throw nt[0]}}c=await this.client.threads.getState(e);let k=c.tasks,L=(b=(w=k==null?void 0:k[0])==null?void 0:w.interrupts)!=null?b:[],J=c.next.length===0,S=(D=(G=c.metadata)==null?void 0:G.writes)!=null?D:{},A=this.activeRun.nodeName;return L!=null&&L.length||(A=J?"__end__":(K=c.next[0])!=null?K:Object.keys(S)[0]),L.forEach(E=>{this.dispatchEvent({type:o.EventType.CUSTOM,name:"on_interrupt",value:typeof E.value=="string"?E.value:JSON.stringify(E.value),rawEvent:E})}),this.handleNodeChange(A),this.handleNodeChange(void 0),this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c)}),this.dispatchEvent({type:o.EventType.MESSAGES_SNAPSHOT,messages:ut((U=c.values.messages)!=null?U:[])}),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:e,runId:this.activeRun.id}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,s.complete()}catch(k){return s.error(k)}}handleSingleEvent(t){var e,s,i,r,g,u,l;switch(t.event){case"on_chat_model_stream":let d=(e=t.metadata["emit-messages"])!=null?e:!0,c=(s=t.metadata["emit-tool-calls"])!=null?s:!0;if(t.data.chunk.response_metadata.finish_reason)return;let h=this.getMessageInProgress(this.activeRun.id),f=!!(h!=null&&h.id),p=(i=t.data.chunk.tool_call_chunks)==null?void 0:i[0],N=(r=t.metadata.predict_state)==null?void 0:r.some(M=>M.tool===(p==null?void 0:p.name)),T=!f&&(p==null?void 0:p.name),R=f&&(h==null?void 0:h.toolCallId)&&(p==null?void 0:p.args),C=f&&(h==null?void 0:h.toolCallId)&&!p;(C||R||T)&&(this.activeRun.hasFunctionStreaming=!0);let v=pt(t.data),x=P(t.data.chunk.content),_=!!(!p&&x),F=f&&!(h!=null&&h.toolCallId)&&!_;if(v){this.handleThinkingEvent(v);break}if(!v&&this.thinkingProcess&&(this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:o.EventType.THINKING_END}),this.thinkingProcess=null),N&&this.dispatchEvent({type:o.EventType.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),C){this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:h==null?void 0:h.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(F){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:h.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(T&&c){this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:p.id,toolCallName:p.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:p.id,toolCallName:p.name});break}if(R&&c){this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:h==null?void 0:h.toolCallId,delta:p.args,rawEvent:t});break}if(_&&d){h||(this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),h=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_CONTENT,messageId:h.id,delta:x,rawEvent:t});break}break;case"on_chat_model_end":if((g=this.getMessageInProgress(this.activeRun.id))!=null&&g.toolCallId){this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((u=this.getMessageInProgress(this.activeRun.id))!=null&&u.id){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot({values:this.activeRun.manuallyEmittedState}),rawEvent:t})),this.dispatchEvent({type:o.EventType.CUSTOM,name:t.name,value:t.data,rawEvent:t});break;case"on_tool_end":let I=(l=t.data)==null?void 0:l.output;this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:I.tool_call_id,toolCallName:I.name,parentMessageId:I.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:I.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:I.tool_call_id,rawEvent:t})),this.dispatchEvent({type:o.EventType.TOOL_CALL_RESULT,toolCallId:I.tool_call_id,content:I==null?void 0:I.content,messageId:(0,V.randomUUID)(),role:"tool"});break}}abortRun(){var s,i;this.cancelRequested=!0;let t=(s=this.activeRun)==null?void 0:s.threadId,e=(i=this.activeRun)==null?void 0:i.id;t&&e&&!this.cancelSent&&this.client.runs.cancel(t,e).then(()=>{this.cancelSent=!0}).catch(()=>{}),super.abortRun()}handleThinkingEvent(t){var s;if(!t||!t.type||!t.text)return;let e=t.index;(s=this.thinkingProcess)!=null&&s.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:o.EventType.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:o.EventType.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=t.values,s=this.activeRun.schemaKeys;return s!=null&&s.output&&(e=q(e,[...this.constantSchemaKeys,...s.output])),e}async getOrCreateThread(t,e){let s;try{try{s=await this.getThread(t)}catch(i){s=await this.createThread({threadId:t,metadata:e})}}catch(i){throw new Error(`Failed to create thread: ${i.message}`)}return s}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:s}){return t.reduce((i,r)=>{var h;let g=i.configurable;r.configurable&&(g=s!=null&&s.config?q(r==null?void 0:r.configurable,[...this.constantSchemaKeys,...(h=s==null?void 0:s.config)!=null?h:[]]):r==null?void 0:r.configurable);let u=y(m(m({},i),r),{configurable:g}),l=i.recursion_limit==null&&r.recursion_limit===25,d=JSON.stringify(u)!==JSON.stringify(i),c=l&&JSON.stringify(y(m({},u),{recursion_limit:null}))===JSON.stringify(y(m({},i),{recursion_limit:null}));return d&&!c?m(m({},i),u):i},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=y(m({},this.messagesInProcess),{[t]:m(m({},this.messagesInProcess[t]),e)})}async getAssistant(){try{let t=await this.client.assistants.search(),e=t.find(s=>s.graph_id===this.graphId);if(!e){let s=`
+"use strict";var j=Object.defineProperty,yt=Object.defineProperties,vt=Object.getOwnPropertyDescriptor,_t=Object.getOwnPropertyDescriptors,Tt=Object.getOwnPropertyNames,$=Object.getOwnPropertySymbols;var z=Object.prototype.hasOwnProperty,ot=Object.prototype.propertyIsEnumerable;var it=(a,n)=>(n=Symbol[a])?n:Symbol.for("Symbol."+a);var rt=(a,n,t)=>n in a?j(a,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[n]=t,m=(a,n)=>{for(var t in n||(n={}))z.call(n,t)&&rt(a,t,n[t]);if($)for(var t of $(n))ot.call(n,t)&&rt(a,t,n[t]);return a},y=(a,n)=>yt(a,_t(n));var lt=(a,n)=>{var t={};for(var e in a)z.call(a,e)&&n.indexOf(e)<0&&(t[e]=a[e]);if(a!=null&&$)for(var e of $(a))n.indexOf(e)<0&&ot.call(a,e)&&(t[e]=a[e]);return t};var Rt=(a,n)=>{for(var t in n)j(a,t,{get:n[t],enumerable:!0})},It=(a,n,t,e)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of Tt(n))!z.call(a,s)&&s!==t&&j(a,s,{get:()=>n[s],enumerable:!(e=vt(n,s))||e.enumerable});return a};var Mt=a=>It(j({},"__esModule",{value:!0}),a);var ht=(a,n,t)=>(n=a[it("asyncIterator")])?n.call(a):(a=a[it("iterator")](),n={},t=(e,s)=>(s=a[e])&&(n[e]=i=>new Promise((r,g,u)=>(i=s.call(a,i),u=i.done,Promise.resolve(i.value).then(l=>r({value:l,done:u}),g)))),t("next"),t("return"),n);var Nt={};Rt(Nt,{CustomEventNames:()=>ct,LangGraphAgent:()=>tt,LangGraphEventTypes:()=>dt,LangGraphHttpAgent:()=>et});module.exports=Mt(Nt);var St=require("@ag-ui/client");var mt=require("rxjs"),ft=require("@langchain/langgraph-sdk"),V=require("@ag-ui/client");var dt=(d=>(d.OnChainStart="on_chain_start",d.OnChainStream="on_chain_stream",d.OnChainEnd="on_chain_end",d.OnChatModelStart="on_chat_model_start",d.OnChatModelStream="on_chat_model_stream",d.OnChatModelEnd="on_chat_model_end",d.OnToolStart="on_tool_start",d.OnToolEnd="on_tool_end",d.OnCustomEvent="on_custom_event",d.OnInterrupt="on_interrupt",d))(dt||{}),ct=(s=>(s.ManuallyEmitMessage="manually_emit_message",s.ManuallyEmitToolCall="manually_emit_tool_call",s.ManuallyEmitState="manually_emit_state",s.Exit="exit",s))(ct||{});var o=require("@ag-ui/client");var Q=["messages","tools"];function q(a,n){return Object.fromEntries(Object.entries(a).filter(([t])=>n.includes(t)))}function gt({mode:a,state:n,schemaKeys:t}){let e=a==="start"?n:null;return e&&(t!=null&&t.input)&&(e=q(e,[...Q,...t.input])),e}function Ct(a){var t;let n=[];for(let e of a)if(e.type==="text"&&e.text)n.push({type:"text",text:e.text});else if(e.type==="image_url"){let s=typeof e.image_url=="string"?e.image_url:(t=e.image_url)==null?void 0:t.url;if(!s)continue;if(s.startsWith("data:")){let[i,r]=s.split(",",2),g=i.includes(":")?i.split(":")[1].split(";")[0]:"image/png";n.push({type:"binary",mimeType:g,data:r||""})}else n.push({type:"binary",mimeType:"image/png",url:s})}return n}function xt(a){let n=[];for(let t of a)if(t.type==="text")n.push({type:"text",text:t.text});else if(t.type==="binary"){let e;if(t.url)e=t.url;else if(t.data)e=`data:${t.mimeType};base64,${t.data}`;else if(t.id)e=t.id;else continue;n.push({type:"image_url",image_url:{url:e}})}return n}function ut(a){return a.map(n=>{var t;switch(n.type){case"human":let e;return Array.isArray(n.content)?e=Ct(n.content):e=X(P(n.content)),{id:n.id,role:"user",content:e};case"ai":let s=P(n.content);return{id:n.id,role:"assistant",content:s?X(s):"",toolCalls:(t=n.tool_calls)==null?void 0:t.map(i=>({id:i.id,type:"function",function:{name:i.name,arguments:JSON.stringify(i.args)}}))};case"system":return{id:n.id,role:"system",content:X(P(n.content))};case"tool":return{id:n.id,role:"tool",content:X(P(n.content)),toolCallId:n.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function Z(a){return a.map((n,t)=>{var e,s;switch(n.role){case"user":let i;return typeof n.content=="string"?i=n.content:Array.isArray(n.content)?i=xt(n.content):i=String(n.content),{id:n.id,role:n.role,content:i,type:"human"};case"assistant":return{id:n.id,type:"ai",role:n.role,content:(e=n.content)!=null?e:"",tool_calls:((s=n.toolCalls)!=null?s:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:n.id,role:n.role,content:n.content,type:"system"};case"tool":return{content:n.content,role:n.role,type:n.role,tool_call_id:n.toolCallId,id:n.id};default:throw console.error(`Message role ${n.role} is not implemented`),new Error("message role is not supported.")}})}function X(a){return typeof a=="string"?a:JSON.stringify(a)}function pt(a){var t,e,s,i,r;let n=(t=a.chunk)==null?void 0:t.content;if(n&&Array.isArray(n)&&n.length&&n[0])return n[0].thinking?{text:n[0].thinking,type:"text",index:n[0].index}:null;if((i=(s=(e=a.chunk.additional_kwargs)==null?void 0:e.reasoning)==null?void 0:s.summary)!=null&&i[0]){let g=(r=a.chunk.additional_kwargs)==null?void 0:r.reasoning.summary[0];return!g||!g.text?null:{type:"text",text:g.text,index:g.index}}return null}function P(a){var n;if(!a)return null;if(typeof a=="string")return a;if(Array.isArray(a)&&a.length){let t=(n=a.find(e=>e.type==="text"))==null?void 0:n.text;return t!=null?t:null}return null}var tt=class a extends o.AbstractAgent{constructor(t){var e,s;super(t);this.cancelRequested=!1;this.cancelSent=!1;this.constantSchemaKeys=Q;this.config=t,this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(s=t==null?void 0:t.client)!=null?s:new ft.Client({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:m({},(e=t.propertyHeaders)!=null?e:{})})}clone(){return new a(this.config)}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return new mt.Observable(e=>(this.runAgentStream(t,e),()=>{}))}connect(t){return new mt.Observable(e=>{(async()=>{var s,a,r,g,u,d,c,l,f,p,N,T;this.subscriber=e,this.cancelRequested=!1,this.cancelSent=!1;let i=(s=t.threadId)!=null?s:(a=t.config)==null?void 0:(r=a.configurable)==null?void 0:r.thread_id;g=t.forwardedProps,i||(i=(u=g)==null?void 0:(d=u.config)==null?void 0:(c=d.configurable)==null?void 0:c.thread_id);if(!i){let b=new Error("Thread ID is required to connect");this.dispatchEvent({type:o.EventType.RUN_ERROR,message:b.message}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,e.error(b);return}let m=g==null?void 0:g.streamMode,y=m!=null?m:["events","values","updates"],v=g==null?void 0:g.lastEventId;v!=null&&(v=String(v));let P=(N=g==null?void 0:g.connectPollIntervalMs)!=null?N:1e3;try{this.assistant||(this.assistant=await this.getAssistant());let b=await this.client.threads.getState(i),k=(l=t.runId)!=null?l:(0,V.randomUUID)();this.activeRun={id:k,threadId:i,hasFunctionStreaming:!1,connectRunStarted:!0,threadStream:!0},this.activeRun.schemaKeys=await this.getSchemaKeys(),this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id),this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:i,runId:k}),b&&(this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(b)}),(p=b.values.messages)!=null&&this.dispatchEvent({type:o.EventType.MESSAGES_SNAPSHOT,messages:lt(p)})),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:i,runId:k});let A;for(;;){if(this.cancelRequested)break;let S=await this.client.runs.list(i),E=S.filter(J=>J.status==="pending"||J.status==="running"),M=E.sort((J,Te)=>Date.parse(Te.updated_at||Te.created_at)-Date.parse(J.updated_at||J.created_at))[0];if(!M){await new Promise(J=>setTimeout(J,P));continue}if(A===M.run_id){await new Promise(J=>setTimeout(J,P));continue}A=M.run_id,this.activeRun={id:M.run_id,threadId:i,hasFunctionStreaming:!1,connectRunStarted:!0,threadStream:!0},this.activeRun.schemaKeys=await this.getSchemaKeys(),this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id),this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:i,runId:M.run_id});let C=await this.client.threads.getState(i),Q=this.client.runs.joinStream(i,M.run_id,{streamMode:y,lastEventId:v});v=void 0,await this.handleStreamEvents({streamResponse:Q,state:C},i,e,t,Array.isArray(y)?y:[y])}this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,e.complete()}catch(b){let E=b instanceof Error?b:new Error(String(b));this.dispatchEvent({type:o.EventType.RUN_ERROR,message:E.message}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,e.error(E)}})(),()=>{}})}async runAgentStream(t,e){var g,u,l;this.activeRun={id:t.runId,threadId:t.threadId,hasFunctionStreaming:!1},this.cancelRequested=!1,this.cancelSent=!1,this.subscriber=e,this.assistant||(this.assistant=await this.getAssistant());let s=(g=t.threadId)!=null?g:(0,V.randomUUID)(),i=(l=(u=t.forwardedProps)==null?void 0:u.streamMode)!=null?l:["events","values","updates"],r=await this.prepareStream(y(m({},t),{threadId:s}),i);if(!r)return e.error("No stream to regenerate");await this.handleStreamEvents(r,s,e,t,Array.isArray(i)?i:[i])}async prepareRegenerateStream(t,e){var l,d,c;let{threadId:s,messageCheckpoint:i}=t,r=await this.getCheckpointByMessage(i.id,s);if(this.assistant||(this.assistant=await this.getAssistant()),!r)return this.subscriber.error("No checkpoint found for message");let g=await this.client.threads.updateState(s,{values:this.langGraphDefaultMergeState(r.values,[],t),checkpointId:r.checkpoint.checkpoint_id,asNode:(d=(l=r.next)==null?void 0:l[0])!=null?d:"__start__"}),u=y(m({},(c=t.forwardedProps)!=null?c:{}),{input:this.langGraphDefaultMergeState(r.values,[i],t),checkpointId:g.checkpoint.checkpoint_id,streamMode:e});return{streamResponse:this.client.runs.stream(s,this.assistant.assistant_id,u),state:r,streamMode:e}}async prepareStream(t,e){var nt,w,b,G,D,K,U,k,L,J;let{threadId:s,state:i,messages:r,tools:g,context:u,forwardedProps:l}=t;this.activeRun.manuallyEmittedState=null;let d=l==null?void 0:l.nodeName,c=s!=null?s:(0,V.randomUUID)();this.assistant||(this.assistant=await this.getAssistant());let h=await this.getOrCreateThread(c,l==null?void 0:l.threadMetadata);this.activeRun.threadId=h.thread_id;let f=(nt=await this.client.threads.getState(h.thread_id))!=null?nt:{values:{}},p=(w=f.values.messages)!=null?w:[],N=Z(r),T=this.langGraphDefaultMergeState(y(m({},i),{messages:p}),N,t),R=y(m({},f),{values:y(m({},T),{messages:[...p,...(b=T.messages)!=null?b:[]]})}),C=R.values;if(this.activeRun.schemaKeys=await this.getSchemaKeys(),((G=f.values.messages)!=null?G:[]).length>r.filter(S=>S.role!=="system").length){let S=null;for(let A=r.length-1;A>=0;A--)if(r[A].role==="user"){S=Z([r[A]])[0];break}return S?this.prepareRegenerateStream(y(m({},t),{messageCheckpoint:S}),e):this.subscriber.error("No user message found in messages to regenerate")}this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id);let v=!((D=l==null?void 0:l.command)!=null&&D.resume)&&c&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(v==="continue"){let S=this.activeRun.graphInfo.edges.find(A=>A.target===this.activeRun.nodeName);await this.client.threads.updateState(c,{values:i,asNode:S==null?void 0:S.source})}let x=gt({mode:v,state:C,schemaKeys:this.activeRun.schemaKeys}),_,F=[this.assistantConfig,l==null?void 0:l.config].filter(Boolean);F.length&&(_=await this.mergeConfigs({configs:F,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let I=y(m({},l),{streamMode:e,input:x,config:_,context:m(m({},u),(K=_==null?void 0:_.configurable)!=null?K:{})}),M=(L=(k=(U=f.tasks)==null?void 0:U[0])==null?void 0:k.interrupts)!=null?L:[];return M!=null&&M.length&&!((J=l==null?void 0:l.command)!=null&&J.resume)?(this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:c,runId:t.runId}),this.handleNodeChange(d),M.forEach(S=>{this.dispatchEvent({type:o.EventType.CUSTOM,name:"on_interrupt",value:typeof S.value=="string"?S.value:JSON.stringify(S.value),rawEvent:S})}),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:c,runId:t.runId}),this.subscriber.complete()):{streamResponse:this.client.runs.stream(c,this.assistant.assistant_id,I),state:R}}async handleStreamEvents(t,e,s,i,r){var p,N,T,R,C,v,x,_,w,b,G,D,K,U;let{forwardedProps:g}=i,u=g==null?void 0:g.nodeName;this.subscriber=s;let l=!1;if(!t)return;let{streamResponse:d,state:c}=t;this.activeRun.prevNodeName=null;let h={},f=c,y=(this.activeRun==null?void 0:this.activeRun.threadStream)===!0;try{this.activeRun!=null&&this.activeRun.connectRunStarted||this.dispatchEvent({type:o.EventType.RUN_STARTED,threadId:e,runId:this.activeRun.id}),this.handleNodeChange(u);try{for(var F=ht(d),I,M,nt;I=!(M=await F.next()).done;I=!1){let E=M.value;if(this.cancelRequested&&!this.cancelSent&&((p=this.activeRun)!=null&&p.threadId)&&((N=this.activeRun)!=null&&N.id)){try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}try{await((T=d==null?void 0:d.return)==null?void 0:T.call(d))}catch(W){}break}let st=(R=i.forwardedProps)==null?void 0:R.streamSubgraphs,Et=st&&(E.event.startsWith("events")||E.event.startsWith("values"));if(!r.includes(E.event)&&!Et&&E.event!=="error")continue;let H=E;if(E.event==="error"){this.dispatchEvent({type:o.EventType.RUN_ERROR,message:E.data.message,rawEvent:E});break}if(E.event==="updates")continue;if(E.event==="values"){h=H.data;continue}else if(st&&H.event.startsWith("values|")){h=m(m({},h),H.data);continue}let B=H.data,Y=(C=B.metadata)!=null?C:{},O=Y.langgraph_node,at=B.event;if(Y.run_id&&(this.activeRun.id=Y.run_id,this.activeRun.serverRunIdKnown=!0,this.cancelRequested&&!this.cancelSent&&((v=this.activeRun)!=null&&v.threadId)))try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}if(O&&O!==this.activeRun.nodeName&&this.handleNodeChange(O),l=l||at==="on_custom_event"&&B.name==="exit",at==="on_chain_end"&&this.activeRun.nodeName===O&&(this.activeRun.exitingNode=!0),this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),(x=this.activeRun.graphInfo)!=null&&x.nodes.some(W=>W.id===O)&&this.handleNodeChange(O),f.values=(_=this.activeRun.manuallyEmittedState)!=null?_:h,!this.activeRun.nodeName)continue;(JSON.stringify(f)!==JSON.stringify(c)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(c=f,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c),rawEvent:H})),this.dispatchEvent({type:o.EventType.RAW,event:B}),this.handleSingleEvent(B)}}catch(M){nt=[M]}finally{try{I&&(M=F.return)&&await M.call(F)}finally{if(nt)throw nt[0]}}c=await this.client.threads.getState(e);let k=c.tasks,L=(b=(w=k==null?void 0:k[0])==null?void 0:w.interrupts)!=null?b:[],J=c.next.length===0,S=(D=(G=c.metadata)==null?void 0:G.writes)!=null?D:{},A=this.activeRun.nodeName;return L!=null&&L.length||(A=J?"__end__":(K=c.next[0])!=null?K:Object.keys(S)[0]),L.forEach(E=>{this.dispatchEvent({type:o.EventType.CUSTOM,name:"on_interrupt",value:typeof E.value=="string"?E.value:JSON.stringify(E.value),rawEvent:E})}),this.handleNodeChange(A),this.handleNodeChange(void 0),this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c)}),this.dispatchEvent({type:o.EventType.MESSAGES_SNAPSHOT,messages:ut((U=c.values.messages)!=null?U:[])}),this.dispatchEvent({type:o.EventType.RUN_FINISHED,threadId:e,runId:this.activeRun.id}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,y||s.complete()}catch(k){return s.error(k)}}handleSingleEvent(t){var e,s,i,r,g,u,l;switch(t.event){case"on_chat_model_stream":let d=(e=t.metadata["emit-messages"])!=null?e:!0,c=(s=t.metadata["emit-tool-calls"])!=null?s:!0;if(t.data.chunk.response_metadata.finish_reason)return;let h=this.getMessageInProgress(this.activeRun.id),f=!!(h!=null&&h.id),p=(i=t.data.chunk.tool_call_chunks)==null?void 0:i[0],N=(r=t.metadata.predict_state)==null?void 0:r.some(M=>M.tool===(p==null?void 0:p.name)),T=!f&&(p==null?void 0:p.name),R=f&&(h==null?void 0:h.toolCallId)&&(p==null?void 0:p.args),C=f&&(h==null?void 0:h.toolCallId)&&!p;(C||R||T)&&(this.activeRun.hasFunctionStreaming=!0);let v=pt(t.data),x=P(t.data.chunk.content),_=!!(!p&&x),F=f&&!(h!=null&&h.toolCallId)&&!_;if(v){this.handleThinkingEvent(v);break}if(!v&&this.thinkingProcess&&(this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:o.EventType.THINKING_END}),this.thinkingProcess=null),N&&this.dispatchEvent({type:o.EventType.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),C){this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:h==null?void 0:h.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(F){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:h.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(T&&c){this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:p.id,toolCallName:p.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:p.id,toolCallName:p.name});break}if(R&&c){this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:h==null?void 0:h.toolCallId,delta:p.args,rawEvent:t});break}if(_&&d){h||(this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),h=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_CONTENT,messageId:h.id,delta:x,rawEvent:t});break}break;case"on_chat_model_end":if((g=this.getMessageInProgress(this.activeRun.id))!=null&&g.toolCallId){this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((u=this.getMessageInProgress(this.activeRun.id))!=null&&u.id){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:o.EventType.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:o.EventType.STATE_SNAPSHOT,snapshot:this.getStateSnapshot({values:this.activeRun.manuallyEmittedState}),rawEvent:t})),this.dispatchEvent({type:o.EventType.CUSTOM,name:t.name,value:t.data,rawEvent:t});break;case"on_tool_end":let I=(l=t.data)==null?void 0:l.output;this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:o.EventType.TOOL_CALL_START,toolCallId:I.tool_call_id,toolCallName:I.name,parentMessageId:I.id,rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_ARGS,toolCallId:I.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t}),this.dispatchEvent({type:o.EventType.TOOL_CALL_END,toolCallId:I.tool_call_id,rawEvent:t})),this.dispatchEvent({type:o.EventType.TOOL_CALL_RESULT,toolCallId:I.tool_call_id,content:I==null?void 0:I.content,messageId:(0,V.randomUUID)(),role:"tool"});break}}abortRun(){var s,i;this.cancelRequested=!0;let t=(s=this.activeRun)==null?void 0:s.threadId,e=(i=this.activeRun)==null?void 0:i.id;t&&e&&!this.cancelSent&&this.client.runs.cancel(t,e).then(()=>{this.cancelSent=!0}).catch(()=>{}),super.abortRun()}handleThinkingEvent(t){var s;if(!t||!t.type||!t.text)return;let e=t.index;(s=this.thinkingProcess)!=null&&s.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:o.EventType.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:o.EventType.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:o.EventType.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=t.values,s=this.activeRun.schemaKeys;return s!=null&&s.output&&(e=q(e,[...this.constantSchemaKeys,...s.output])),e}async getOrCreateThread(t,e){let s;try{try{s=await this.getThread(t)}catch(i){s=await this.createThread({threadId:t,metadata:e})}}catch(i){throw new Error(`Failed to create thread: ${i.message}`)}return s}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:s}){return t.reduce((i,r)=>{var h;let g=i.configurable;r.configurable&&(g=s!=null&&s.config?q(r==null?void 0:r.configurable,[...this.constantSchemaKeys,...(h=s==null?void 0:s.config)!=null?h:[]]):r==null?void 0:r.configurable);let u=y(m(m({},i),r),{configurable:g}),l=i.recursion_limit==null&&r.recursion_limit===25,d=JSON.stringify(u)!==JSON.stringify(i),c=l&&JSON.stringify(y(m({},u),{recursion_limit:null}))===JSON.stringify(y(m({},i),{recursion_limit:null}));return d&&!c?m(m({},i),u):i},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=y(m({},this.messagesInProcess),{[t]:m(m({},this.messagesInProcess[t]),e)})}async getAssistant(){try{let t=await this.client.assistants.search(),e=t.find(s=>s.graph_id===this.graphId);if(!e){let s=`
       No agent found with graph ID ${this.graphId} found..
 
 
       These are the available agents: [${t.map(i=>`${i.graph_id} (ID: ${i.assistant_id})`).join(", ")}]
-      `;throw console.error(s),new Error(s)}return e}catch(t){let e=new Error(`Failed to retrieve assistant: ${t.message}`);throw this.dispatchEvent({type:o.EventType.RUN_ERROR,message:e.message}),this.subscriber.error(),e}}async getSchemaKeys(){var t,e,s,i;try{let r=await this.client.assistants.getSchemas(this.assistant.assistant_id),g=null,u=[];if("context_schema"in r&&((t=r.context_schema)!=null&&t.properties)&&(u=Object.keys(r.context_schema.properties)),(e=r.config_schema)!=null&&e.properties&&(g=Object.keys(r.config_schema.properties)),!((s=r.input_schema)!=null&&s.properties)||!((i=r.output_schema)!=null&&i.properties))return{config:[],input:null,output:null,context:u};let l=Object.keys(r.input_schema.properties),d=Object.keys(r.output_schema.properties);return{input:l&&l.length?[...l,...this.constantSchemaKeys]:null,output:d&&d.length?[...d,...this.constantSchemaKeys]:null,context:u,config:g}}catch(r){return{config:[],input:this.constantSchemaKeys,output:this.constantSchemaKeys,context:[]}}}langGraphDefaultMergeState(t,e,s){var l,d;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let i=t.messages||[],r=new Set(i.map(c=>c.id)),g=e.filter(c=>!r.has(c.id)),u=[...(l=t.tools)!=null?l:[],...(d=s.tools)!=null?d:[]].reduce((c,h)=>{let f=h;return h.type||(f={type:"function",name:h.name,function:{name:h.name,description:h.description,parameters:h.parameters}}),c.find(p=>p.name===f.name||p.function.name===f.function.name)?c:[...c,f]},[]);return y(m({},t),{messages:g,tools:u,"ag-ui":{tools:u,context:s.context}})}handleNodeChange(t){var e,s;t==="__end__"&&(t=void 0),t!==((e=this.activeRun)==null?void 0:e.nodeName)&&((s=this.activeRun)!=null&&s.nodeName&&this.endStep(),t&&this.startStep(t)),this.activeRun.nodeName=t}startStep(t){this.dispatchEvent({type:o.EventType.STEP_STARTED,stepName:t})}endStep(){this.dispatchEvent({type:o.EventType.STEP_FINISHED,stepName:this.activeRun.nodeName})}async getCheckpointByMessage(t,e,s){var T,C;let i=s!=null&&s.checkpoint_id?{checkpoint:{checkpoint_id:s.checkpoint_id}}:void 0,g=[...await this.client.threads.getHistory(e,i)].reverse(),u=g.find(v=>{var x;return(x=v.values.messages)==null?void 0:x.some(_=>_.id===t)});if(!u)throw new Error("Message not found");let l=(T=u.values.messages)!=null?T:[],d=l.findIndex(v=>v.id===t);if(l.slice(d+1).length)return this.getCheckpointByMessage(t,e,u.parent_checkpoint);let h=g.indexOf(u),R=u.values,{messages:f}=R,p=lt(R,["messages"]),N=(C=g[h-1])!=null?C:y(m({},u),{values:{}});return y(m({},N),{values:m(m({},N.values),p)})}};var et=class extends St.HttpAgent{};0&&(module.exports={CustomEventNames,LangGraphAgent,LangGraphEventTypes,LangGraphHttpAgent});
+      `;throw console.error(s),new Error(s)}return e}catch(t){let e=new Error(`Failed to retrieve assistant: ${t.message}`);throw this.dispatchEvent({type:o.EventType.RUN_ERROR,message:e.message}),this.subscriber.error(),e}}async getSchemaKeys(){var t,e,s,i;try{let r=await this.client.assistants.getSchemas(this.assistant.assistant_id),g=null,u=[];if("context_schema"in r&&((t=r.context_schema)!=null&&t.properties)&&(u=Object.keys(r.context_schema.properties)),(e=r.config_schema)!=null&&e.properties&&(g=Object.keys(r.config_schema.properties)),!((s=r.input_schema)!=null&&s.properties)||!((i=r.output_schema)!=null&&i.properties))return{config:[],input:null,output:null,context:u};let l=Object.keys(r.input_schema.properties),d=Object.keys(r.output_schema.properties);return{input:l&&l.length?[...l,...this.constantSchemaKeys]:null,output:d&&d.length?[...d,...this.constantSchemaKeys]:null,context:u,config:g}}catch(r){return{config:[],input:null,output:null,context:[]}}}langGraphDefaultMergeState(t,e,s){var l,d;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let i=t.messages||[],r=new Set(i.map(c=>c.id)),g=e.filter(c=>!r.has(c.id)),u=[...(l=t.tools)!=null?l:[],...(d=s.tools)!=null?d:[]].reduce((c,h)=>{let f=h;return h.type||(f={type:"function",name:h.name,function:{name:h.name,description:h.description,parameters:h.parameters}}),c.find(p=>p.name===f.name||p.function.name===f.function.name)?c:[...c,f]},[]);return y(m({},t),{messages:g,tools:u,"ag-ui":{tools:u,context:s.context}})}handleNodeChange(t){var e,s;t==="__end__"&&(t=void 0),t!==((e=this.activeRun)==null?void 0:e.nodeName)&&((s=this.activeRun)!=null&&s.nodeName&&this.endStep(),t&&this.startStep(t)),this.activeRun.nodeName=t}startStep(t){this.dispatchEvent({type:o.EventType.STEP_STARTED,stepName:t})}endStep(){this.dispatchEvent({type:o.EventType.STEP_FINISHED,stepName:this.activeRun.nodeName})}async getCheckpointByMessage(t,e,s){var T,C;let i=s!=null&&s.checkpoint_id?{checkpoint:{checkpoint_id:s.checkpoint_id}}:void 0,g=[...await this.client.threads.getHistory(e,i)].reverse(),u=g.find(v=>{var x;return(x=v.values.messages)==null?void 0:x.some(_=>_.id===t)});if(!u)throw new Error("Message not found");let l=(T=u.values.messages)!=null?T:[],d=l.findIndex(v=>v.id===t);if(l.slice(d+1).length)return this.getCheckpointByMessage(t,e,u.parent_checkpoint);let h=g.indexOf(u),R=u.values,{messages:f}=R,p=lt(R,["messages"]),N=(C=g[h-1])!=null?C:y(m({},u),{values:{}});return y(m({},N),{values:m(m({},N.values),p)})}};var et=class extends St.HttpAgent{};0&&(module.exports={CustomEventNames,LangGraphAgent,LangGraphEventTypes,LangGraphHttpAgent});
 //# sourceMappingURL=index.js.map
\ No newline at end of file
diff --git a/dist/index.mjs b/dist/index.mjs
index d5f6574895f99cb84ffb9b5552c067b515f6276d..2102efc3daa68cda10274983ea5ed0303019bee3 100644
--- a/dist/index.mjs
+++ b/dist/index.mjs
@@ -1,7 +1,7 @@
-var ut=Object.defineProperty,pt=Object.defineProperties;var mt=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var st=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable;var et=(i,n)=>(n=Symbol[i])?n:Symbol.for("Symbol."+i);var nt=(i,n,t)=>n in i?ut(i,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[n]=t,m=(i,n)=>{for(var t in n||(n={}))st.call(n,t)&&nt(i,t,n[t]);if($)for(var t of $(n))at.call(n,t)&&nt(i,t,n[t]);return i},y=(i,n)=>pt(i,mt(n));var it=(i,n)=>{var t={};for(var e in i)st.call(i,e)&&n.indexOf(e)<0&&(t[e]=i[e]);if(i!=null&&$)for(var e of $(i))n.indexOf(e)<0&&at.call(i,e)&&(t[e]=i[e]);return t};var rt=(i,n,t)=>(n=i[et("asyncIterator")])?n.call(i):(i=i[et("iterator")](),n={},t=(e,s)=>(s=i[e])&&(n[e]=a=>new Promise((r,g,u)=>(a=s.call(i,a),u=a.done,Promise.resolve(a.value).then(o=>r({value:o,done:u}),g)))),t("next"),t("return"),n);import{HttpAgent as Rt}from"@ag-ui/client";import{Observable as vt}from"rxjs";import{Client as _t}from"@langchain/langgraph-sdk";import{randomUUID as z}from"@ag-ui/client";var ft=(d=>(d.OnChainStart="on_chain_start",d.OnChainStream="on_chain_stream",d.OnChainEnd="on_chain_end",d.OnChatModelStart="on_chat_model_start",d.OnChatModelStream="on_chat_model_stream",d.OnChatModelEnd="on_chat_model_end",d.OnToolStart="on_tool_start",d.OnToolEnd="on_tool_end",d.OnCustomEvent="on_custom_event",d.OnInterrupt="on_interrupt",d))(ft||{}),St=(s=>(s.ManuallyEmitMessage="manually_emit_message",s.ManuallyEmitToolCall="manually_emit_tool_call",s.ManuallyEmitState="manually_emit_state",s.Exit="exit",s))(St||{});import{AbstractAgent as Tt,EventType as h}from"@ag-ui/client";var V=["messages","tools"];function X(i,n){return Object.fromEntries(Object.entries(i).filter(([t])=>n.includes(t)))}function ot({mode:i,state:n,schemaKeys:t}){let e=i==="start"?n:null;return e&&(t!=null&&t.input)&&(e=X(e,[...V,...t.input])),e}function Et(i){var t;let n=[];for(let e of i)if(e.type==="text"&&e.text)n.push({type:"text",text:e.text});else if(e.type==="image_url"){let s=typeof e.image_url=="string"?e.image_url:(t=e.image_url)==null?void 0:t.url;if(!s)continue;if(s.startsWith("data:")){let[a,r]=s.split(",",2),g=a.includes(":")?a.split(":")[1].split(";")[0]:"image/png";n.push({type:"binary",mimeType:g,data:r||""})}else n.push({type:"binary",mimeType:"image/png",url:s})}return n}function yt(i){let n=[];for(let t of i)if(t.type==="text")n.push({type:"text",text:t.text});else if(t.type==="binary"){let e;if(t.url)e=t.url;else if(t.data)e=`data:${t.mimeType};base64,${t.data}`;else if(t.id)e=t.id;else continue;n.push({type:"image_url",image_url:{url:e}})}return n}function lt(i){return i.map(n=>{var t;switch(n.type){case"human":let e;return Array.isArray(n.content)?e=Et(n.content):e=j(P(n.content)),{id:n.id,role:"user",content:e};case"ai":let s=P(n.content);return{id:n.id,role:"assistant",content:s?j(s):"",toolCalls:(t=n.tool_calls)==null?void 0:t.map(a=>({id:a.id,type:"function",function:{name:a.name,arguments:JSON.stringify(a.args)}}))};case"system":return{id:n.id,role:"system",content:j(P(n.content))};case"tool":return{id:n.id,role:"tool",content:j(P(n.content)),toolCallId:n.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function Y(i){return i.map((n,t)=>{var e,s;switch(n.role){case"user":let a;return typeof n.content=="string"?a=n.content:Array.isArray(n.content)?a=yt(n.content):a=String(n.content),{id:n.id,role:n.role,content:a,type:"human"};case"assistant":return{id:n.id,type:"ai",role:n.role,content:(e=n.content)!=null?e:"",tool_calls:((s=n.toolCalls)!=null?s:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:n.id,role:n.role,content:n.content,type:"system"};case"tool":return{content:n.content,role:n.role,type:n.role,tool_call_id:n.toolCallId,id:n.id};default:throw console.error(`Message role ${n.role} is not implemented`),new Error("message role is not supported.")}})}function j(i){return typeof i=="string"?i:JSON.stringify(i)}function ht(i){var t,e,s,a,r;let n=(t=i.chunk)==null?void 0:t.content;if(n&&Array.isArray(n)&&n.length&&n[0])return n[0].thinking?{text:n[0].thinking,type:"text",index:n[0].index}:null;if((a=(s=(e=i.chunk.additional_kwargs)==null?void 0:e.reasoning)==null?void 0:s.summary)!=null&&a[0]){let g=(r=i.chunk.additional_kwargs)==null?void 0:r.reasoning.summary[0];return!g||!g.text?null:{type:"text",text:g.text,index:g.index}}return null}function P(i){var n;if(!i)return null;if(typeof i=="string")return i;if(Array.isArray(i)&&i.length){let t=(n=i.find(e=>e.type==="text"))==null?void 0:n.text;return t!=null?t:null}return null}var dt=class i extends Tt{constructor(t){var e,s;super(t);this.cancelRequested=!1;this.cancelSent=!1;this.constantSchemaKeys=V;this.config=t,this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(s=t==null?void 0:t.client)!=null?s:new _t({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:m({},(e=t.propertyHeaders)!=null?e:{})})}clone(){return new i(this.config)}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return new vt(e=>(this.runAgentStream(t,e),()=>{}))}async runAgentStream(t,e){var g,u,o;this.activeRun={id:t.runId,threadId:t.threadId,hasFunctionStreaming:!1},this.cancelRequested=!1,this.cancelSent=!1,this.subscriber=e,this.assistant||(this.assistant=await this.getAssistant());let s=(g=t.threadId)!=null?g:z(),a=(o=(u=t.forwardedProps)==null?void 0:u.streamMode)!=null?o:["events","values","updates"],r=await this.prepareStream(y(m({},t),{threadId:s}),a);if(!r)return e.error("No stream to regenerate");await this.handleStreamEvents(r,s,e,t,Array.isArray(a)?a:[a])}async prepareRegenerateStream(t,e){var o,d,c;let{threadId:s,messageCheckpoint:a}=t,r=await this.getCheckpointByMessage(a.id,s);if(this.assistant||(this.assistant=await this.getAssistant()),!r)return this.subscriber.error("No checkpoint found for message");let g=await this.client.threads.updateState(s,{values:this.langGraphDefaultMergeState(r.values,[],t),checkpointId:r.checkpoint.checkpoint_id,asNode:(d=(o=r.next)==null?void 0:o[0])!=null?d:"__start__"}),u=y(m({},(c=t.forwardedProps)!=null?c:{}),{input:this.langGraphDefaultMergeState(r.values,[a],t),checkpointId:g.checkpoint.checkpoint_id,streamMode:e});return{streamResponse:this.client.runs.stream(s,this.assistant.assistant_id,u),state:r,streamMode:e}}async prepareStream(t,e){var Q,w,b,G,D,K,U,k,L,J;let{threadId:s,state:a,messages:r,tools:g,context:u,forwardedProps:o}=t;this.activeRun.manuallyEmittedState=null;let d=o==null?void 0:o.nodeName,c=s!=null?s:z();this.assistant||(this.assistant=await this.getAssistant());let l=await this.getOrCreateThread(c,o==null?void 0:o.threadMetadata);this.activeRun.threadId=l.thread_id;let f=(Q=await this.client.threads.getState(l.thread_id))!=null?Q:{values:{}},p=(w=f.values.messages)!=null?w:[],N=Y(r),T=this.langGraphDefaultMergeState(y(m({},a),{messages:p}),N,t),R=y(m({},f),{values:y(m({},T),{messages:[...p,...(b=T.messages)!=null?b:[]]})}),C=R.values;if(this.activeRun.schemaKeys=await this.getSchemaKeys(),((G=f.values.messages)!=null?G:[]).length>r.filter(S=>S.role!=="system").length){let S=null;for(let A=r.length-1;A>=0;A--)if(r[A].role==="user"){S=Y([r[A]])[0];break}return S?this.prepareRegenerateStream(y(m({},t),{messageCheckpoint:S}),e):this.subscriber.error("No user message found in messages to regenerate")}this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id);let v=!((D=o==null?void 0:o.command)!=null&&D.resume)&&c&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(v==="continue"){let S=this.activeRun.graphInfo.edges.find(A=>A.target===this.activeRun.nodeName);await this.client.threads.updateState(c,{values:a,asNode:S==null?void 0:S.source})}let x=ot({mode:v,state:C,schemaKeys:this.activeRun.schemaKeys}),_,F=[this.assistantConfig,o==null?void 0:o.config].filter(Boolean);F.length&&(_=await this.mergeConfigs({configs:F,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let I=y(m({},o),{streamMode:e,input:x,config:_,context:m(m({},u),(K=_==null?void 0:_.configurable)!=null?K:{})}),M=(L=(k=(U=f.tasks)==null?void 0:U[0])==null?void 0:k.interrupts)!=null?L:[];return M!=null&&M.length&&!((J=o==null?void 0:o.command)!=null&&J.resume)?(this.dispatchEvent({type:h.RUN_STARTED,threadId:c,runId:t.runId}),this.handleNodeChange(d),M.forEach(S=>{this.dispatchEvent({type:h.CUSTOM,name:"on_interrupt",value:typeof S.value=="string"?S.value:JSON.stringify(S.value),rawEvent:S})}),this.dispatchEvent({type:h.RUN_FINISHED,threadId:c,runId:t.runId}),this.subscriber.complete()):{streamResponse:this.client.runs.stream(c,this.assistant.assistant_id,I),state:R}}async handleStreamEvents(t,e,s,a,r){var p,N,T,R,C,v,x,_,w,b,G,D,K,U;let{forwardedProps:g}=a,u=g==null?void 0:g.nodeName;this.subscriber=s;let o=!1;if(!t)return;let{streamResponse:d,state:c}=t;this.activeRun.prevNodeName=null;let l={},f=c;try{this.dispatchEvent({type:h.RUN_STARTED,threadId:e,runId:this.activeRun.id}),this.handleNodeChange(u);try{for(var F=rt(d),I,M,Q;I=!(M=await F.next()).done;I=!1){let E=M.value;if(this.cancelRequested&&!this.cancelSent&&((p=this.activeRun)!=null&&p.threadId)&&((N=this.activeRun)!=null&&N.id)){try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}try{await((T=d==null?void 0:d.return)==null?void 0:T.call(d))}catch(W){}break}let Z=(R=a.forwardedProps)==null?void 0:R.streamSubgraphs,gt=Z&&(E.event.startsWith("events")||E.event.startsWith("values"));if(!r.includes(E.event)&&!gt&&E.event!=="error")continue;let H=E;if(E.event==="error"){this.dispatchEvent({type:h.RUN_ERROR,message:E.data.message,rawEvent:E});break}if(E.event==="updates")continue;if(E.event==="values"){l=H.data;continue}else if(Z&&H.event.startsWith("values|")){l=m(m({},l),H.data);continue}let B=H.data,q=(C=B.metadata)!=null?C:{},O=q.langgraph_node,tt=B.event;if(q.run_id&&(this.activeRun.id=q.run_id,this.activeRun.serverRunIdKnown=!0,this.cancelRequested&&!this.cancelSent&&((v=this.activeRun)!=null&&v.threadId)))try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}if(O&&O!==this.activeRun.nodeName&&this.handleNodeChange(O),o=o||tt==="on_custom_event"&&B.name==="exit",tt==="on_chain_end"&&this.activeRun.nodeName===O&&(this.activeRun.exitingNode=!0),this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),(x=this.activeRun.graphInfo)!=null&&x.nodes.some(W=>W.id===O)&&this.handleNodeChange(O),f.values=(_=this.activeRun.manuallyEmittedState)!=null?_:l,!this.activeRun.nodeName)continue;(JSON.stringify(f)!==JSON.stringify(c)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(c=f,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c),rawEvent:H})),this.dispatchEvent({type:h.RAW,event:B}),this.handleSingleEvent(B)}}catch(M){Q=[M]}finally{try{I&&(M=F.return)&&await M.call(F)}finally{if(Q)throw Q[0]}}c=await this.client.threads.getState(e);let k=c.tasks,L=(b=(w=k==null?void 0:k[0])==null?void 0:w.interrupts)!=null?b:[],J=c.next.length===0,S=(D=(G=c.metadata)==null?void 0:G.writes)!=null?D:{},A=this.activeRun.nodeName;return L!=null&&L.length||(A=J?"__end__":(K=c.next[0])!=null?K:Object.keys(S)[0]),L.forEach(E=>{this.dispatchEvent({type:h.CUSTOM,name:"on_interrupt",value:typeof E.value=="string"?E.value:JSON.stringify(E.value),rawEvent:E})}),this.handleNodeChange(A),this.handleNodeChange(void 0),this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c)}),this.dispatchEvent({type:h.MESSAGES_SNAPSHOT,messages:lt((U=c.values.messages)!=null?U:[])}),this.dispatchEvent({type:h.RUN_FINISHED,threadId:e,runId:this.activeRun.id}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,s.complete()}catch(k){return s.error(k)}}handleSingleEvent(t){var e,s,a,r,g,u,o;switch(t.event){case"on_chat_model_stream":let d=(e=t.metadata["emit-messages"])!=null?e:!0,c=(s=t.metadata["emit-tool-calls"])!=null?s:!0;if(t.data.chunk.response_metadata.finish_reason)return;let l=this.getMessageInProgress(this.activeRun.id),f=!!(l!=null&&l.id),p=(a=t.data.chunk.tool_call_chunks)==null?void 0:a[0],N=(r=t.metadata.predict_state)==null?void 0:r.some(M=>M.tool===(p==null?void 0:p.name)),T=!f&&(p==null?void 0:p.name),R=f&&(l==null?void 0:l.toolCallId)&&(p==null?void 0:p.args),C=f&&(l==null?void 0:l.toolCallId)&&!p;(C||R||T)&&(this.activeRun.hasFunctionStreaming=!0);let v=ht(t.data),x=P(t.data.chunk.content),_=!!(!p&&x),F=f&&!(l!=null&&l.toolCallId)&&!_;if(v){this.handleThinkingEvent(v);break}if(!v&&this.thinkingProcess&&(this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:h.THINKING_END}),this.thinkingProcess=null),N&&this.dispatchEvent({type:h.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),C){this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:l==null?void 0:l.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(F){this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:l.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(T&&c){this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:p.id,toolCallName:p.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:p.id,toolCallName:p.name});break}if(R&&c){this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:l==null?void 0:l.toolCallId,delta:p.args,rawEvent:t});break}if(_&&d){l||(this.dispatchEvent({type:h.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),l=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:h.TEXT_MESSAGE_CONTENT,messageId:l.id,delta:x,rawEvent:t});break}break;case"on_chat_model_end":if((g=this.getMessageInProgress(this.activeRun.id))!=null&&g.toolCallId){this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((u=this.getMessageInProgress(this.activeRun.id))!=null&&u.id){this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:h.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:h.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot({values:this.activeRun.manuallyEmittedState}),rawEvent:t})),this.dispatchEvent({type:h.CUSTOM,name:t.name,value:t.data,rawEvent:t});break;case"on_tool_end":let I=(o=t.data)==null?void 0:o.output;this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:I.tool_call_id,toolCallName:I.name,parentMessageId:I.id,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:I.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:I.tool_call_id,rawEvent:t})),this.dispatchEvent({type:h.TOOL_CALL_RESULT,toolCallId:I.tool_call_id,content:I==null?void 0:I.content,messageId:z(),role:"tool"});break}}abortRun(){var s,a;this.cancelRequested=!0;let t=(s=this.activeRun)==null?void 0:s.threadId,e=(a=this.activeRun)==null?void 0:a.id;t&&e&&!this.cancelSent&&this.client.runs.cancel(t,e).then(()=>{this.cancelSent=!0}).catch(()=>{}),super.abortRun()}handleThinkingEvent(t){var s;if(!t||!t.type||!t.text)return;let e=t.index;(s=this.thinkingProcess)!=null&&s.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:h.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:h.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=t.values,s=this.activeRun.schemaKeys;return s!=null&&s.output&&(e=X(e,[...this.constantSchemaKeys,...s.output])),e}async getOrCreateThread(t,e){let s;try{try{s=await this.getThread(t)}catch(a){s=await this.createThread({threadId:t,metadata:e})}}catch(a){throw new Error(`Failed to create thread: ${a.message}`)}return s}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:s}){return t.reduce((a,r)=>{var l;let g=a.configurable;r.configurable&&(g=s!=null&&s.config?X(r==null?void 0:r.configurable,[...this.constantSchemaKeys,...(l=s==null?void 0:s.config)!=null?l:[]]):r==null?void 0:r.configurable);let u=y(m(m({},a),r),{configurable:g}),o=a.recursion_limit==null&&r.recursion_limit===25,d=JSON.stringify(u)!==JSON.stringify(a),c=o&&JSON.stringify(y(m({},u),{recursion_limit:null}))===JSON.stringify(y(m({},a),{recursion_limit:null}));return d&&!c?m(m({},a),u):a},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=y(m({},this.messagesInProcess),{[t]:m(m({},this.messagesInProcess[t]),e)})}async getAssistant(){try{let t=await this.client.assistants.search(),e=t.find(s=>s.graph_id===this.graphId);if(!e){let s=`
+var ut=Object.defineProperty,pt=Object.defineProperties;var mt=Object.getOwnPropertyDescriptors;var $=Object.getOwnPropertySymbols;var st=Object.prototype.hasOwnProperty,at=Object.prototype.propertyIsEnumerable;var et=(i,n)=>(n=Symbol[i])?n:Symbol.for("Symbol."+i);var nt=(i,n,t)=>n in i?ut(i,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[n]=t,m=(i,n)=>{for(var t in n||(n={}))st.call(n,t)&&nt(i,t,n[t]);if($)for(var t of $(n))at.call(n,t)&&nt(i,t,n[t]);return i},y=(i,n)=>pt(i,mt(n));var it=(i,n)=>{var t={};for(var e in i)st.call(i,e)&&n.indexOf(e)<0&&(t[e]=i[e]);if(i!=null&&$)for(var e of $(i))n.indexOf(e)<0&&at.call(i,e)&&(t[e]=i[e]);return t};var rt=(i,n,t)=>(n=i[et("asyncIterator")])?n.call(i):(i=i[et("iterator")](),n={},t=(e,s)=>(s=i[e])&&(n[e]=a=>new Promise((r,g,u)=>(a=s.call(i,a),u=a.done,Promise.resolve(a.value).then(o=>r({value:o,done:u}),g)))),t("next"),t("return"),n);import{HttpAgent as Rt}from"@ag-ui/client";import{Observable as vt}from"rxjs";import{Client as _t}from"@langchain/langgraph-sdk";import{randomUUID as z}from"@ag-ui/client";var ft=(d=>(d.OnChainStart="on_chain_start",d.OnChainStream="on_chain_stream",d.OnChainEnd="on_chain_end",d.OnChatModelStart="on_chat_model_start",d.OnChatModelStream="on_chat_model_stream",d.OnChatModelEnd="on_chat_model_end",d.OnToolStart="on_tool_start",d.OnToolEnd="on_tool_end",d.OnCustomEvent="on_custom_event",d.OnInterrupt="on_interrupt",d))(ft||{}),St=(s=>(s.ManuallyEmitMessage="manually_emit_message",s.ManuallyEmitToolCall="manually_emit_tool_call",s.ManuallyEmitState="manually_emit_state",s.Exit="exit",s))(St||{});import{AbstractAgent as Tt,EventType as h}from"@ag-ui/client";var V=["messages","tools"];function X(i,n){return Object.fromEntries(Object.entries(i).filter(([t])=>n.includes(t)))}function ot({mode:i,state:n,schemaKeys:t}){let e=i==="start"?n:null;return e&&(t!=null&&t.input)&&(e=X(e,[...V,...t.input])),e}function Et(i){var t;let n=[];for(let e of i)if(e.type==="text"&&e.text)n.push({type:"text",text:e.text});else if(e.type==="image_url"){let s=typeof e.image_url=="string"?e.image_url:(t=e.image_url)==null?void 0:t.url;if(!s)continue;if(s.startsWith("data:")){let[a,r]=s.split(",",2),g=a.includes(":")?a.split(":")[1].split(";")[0]:"image/png";n.push({type:"binary",mimeType:g,data:r||""})}else n.push({type:"binary",mimeType:"image/png",url:s})}return n}function yt(i){let n=[];for(let t of i)if(t.type==="text")n.push({type:"text",text:t.text});else if(t.type==="binary"){let e;if(t.url)e=t.url;else if(t.data)e=`data:${t.mimeType};base64,${t.data}`;else if(t.id)e=t.id;else continue;n.push({type:"image_url",image_url:{url:e}})}return n}function lt(i){return i.map(n=>{var t;switch(n.type){case"human":let e;return Array.isArray(n.content)?e=Et(n.content):e=j(P(n.content)),{id:n.id,role:"user",content:e};case"ai":let s=P(n.content);return{id:n.id,role:"assistant",content:s?j(s):"",toolCalls:(t=n.tool_calls)==null?void 0:t.map(a=>({id:a.id,type:"function",function:{name:a.name,arguments:JSON.stringify(a.args)}}))};case"system":return{id:n.id,role:"system",content:j(P(n.content))};case"tool":return{id:n.id,role:"tool",content:j(P(n.content)),toolCallId:n.tool_call_id};default:throw new Error("message type returned from LangGraph is not supported.")}})}function Y(i){return i.map((n,t)=>{var e,s;switch(n.role){case"user":let a;return typeof n.content=="string"?a=n.content:Array.isArray(n.content)?a=yt(n.content):a=String(n.content),{id:n.id,role:n.role,content:a,type:"human"};case"assistant":return{id:n.id,type:"ai",role:n.role,content:(e=n.content)!=null?e:"",tool_calls:((s=n.toolCalls)!=null?s:[]).map(r=>({id:r.id,name:r.function.name,args:JSON.parse(r.function.arguments),type:"tool_call"}))};case"system":return{id:n.id,role:n.role,content:n.content,type:"system"};case"tool":return{content:n.content,role:n.role,type:n.role,tool_call_id:n.toolCallId,id:n.id};default:throw console.error(`Message role ${n.role} is not implemented`),new Error("message role is not supported.")}})}function j(i){return typeof i=="string"?i:JSON.stringify(i)}function ht(i){var t,e,s,a,r;let n=(t=i.chunk)==null?void 0:t.content;if(n&&Array.isArray(n)&&n.length&&n[0])return n[0].thinking?{text:n[0].thinking,type:"text",index:n[0].index}:null;if((a=(s=(e=i.chunk.additional_kwargs)==null?void 0:e.reasoning)==null?void 0:s.summary)!=null&&a[0]){let g=(r=i.chunk.additional_kwargs)==null?void 0:r.reasoning.summary[0];return!g||!g.text?null:{type:"text",text:g.text,index:g.index}}return null}function P(i){var n;if(!i)return null;if(typeof i=="string")return i;if(Array.isArray(i)&&i.length){let t=(n=i.find(e=>e.type==="text"))==null?void 0:n.text;return t!=null?t:null}return null}var dt=class i extends Tt{constructor(t){var e,s;super(t);this.cancelRequested=!1;this.cancelSent=!1;this.constantSchemaKeys=V;this.config=t,this.messagesInProcess={},this.agentName=t.agentName,this.graphId=t.graphId,this.assistantConfig=t.assistantConfig,this.thinkingProcess=null,this.client=(s=t==null?void 0:t.client)!=null?s:new _t({apiUrl:t.deploymentUrl,apiKey:t.langsmithApiKey,defaultHeaders:m({},(e=t.propertyHeaders)!=null?e:{})})}clone(){return new i(this.config)}dispatchEvent(t){return this.subscriber.next(t),!0}run(t){return new vt(e=>(this.runAgentStream(t,e),()=>{}))}connect(t){return new vt(e=>{(async()=>{var s,a,r,g,u,d,c,l,f,p,N,T;this.subscriber=e,this.cancelRequested=!1,this.cancelSent=!1;let i=(s=t.threadId)!=null?s:(a=t.config)==null?void 0:(r=a.configurable)==null?void 0:r.thread_id;g=t.forwardedProps,i||(i=(u=g)==null?void 0:(d=u.config)==null?void 0:(c=d.configurable)==null?void 0:c.thread_id);if(!i){let b=new Error("Thread ID is required to connect");this.dispatchEvent({type:h.RUN_ERROR,message:b.message}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,e.error(b);return}let m=g==null?void 0:g.streamMode,y=m!=null?m:["events","values","updates"],v=g==null?void 0:g.lastEventId;v!=null&&(v=String(v));let P=(N=g==null?void 0:g.connectPollIntervalMs)!=null?N:1e3;try{this.assistant||(this.assistant=await this.getAssistant());let b=await this.client.threads.getState(i),k=(l=t.runId)!=null?l:z();this.activeRun={id:k,threadId:i,hasFunctionStreaming:!1,connectRunStarted:!0,threadStream:!0},this.activeRun.schemaKeys=await this.getSchemaKeys(),this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id),this.dispatchEvent({type:h.RUN_STARTED,threadId:i,runId:k}),b&&(this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(b)}),(p=b.values.messages)!=null&&this.dispatchEvent({type:h.MESSAGES_SNAPSHOT,messages:lt(p)})),this.dispatchEvent({type:h.RUN_FINISHED,threadId:i,runId:k});let A;for(;;){if(this.cancelRequested)break;let S=await this.client.runs.list(i),E=S.filter(J=>J.status==="pending"||J.status==="running"),M=E.sort((J,Te)=>Date.parse(Te.updated_at||Te.created_at)-Date.parse(J.updated_at||J.created_at))[0];if(!M){await new Promise(J=>setTimeout(J,P));continue}if(A===M.run_id){await new Promise(J=>setTimeout(J,P));continue}A=M.run_id,this.activeRun={id:M.run_id,threadId:i,hasFunctionStreaming:!1,connectRunStarted:!0,threadStream:!0},this.activeRun.schemaKeys=await this.getSchemaKeys(),this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id),this.dispatchEvent({type:h.RUN_STARTED,threadId:i,runId:M.run_id});let C=await this.client.threads.getState(i),Q=this.client.runs.joinStream(i,M.run_id,{streamMode:y,lastEventId:v});v=void 0,await this.handleStreamEvents({streamResponse:Q,state:C},i,e,t,Array.isArray(y)?y:[y])}this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,e.complete()}catch(b){let E=b instanceof Error?b:new Error(String(b));this.dispatchEvent({type:h.RUN_ERROR,message:E.message}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,e.error(E)}})(),()=>{}})}async runAgentStream(t,e){var g,u,o;this.activeRun={id:t.runId,threadId:t.threadId,hasFunctionStreaming:!1},this.cancelRequested=!1,this.cancelSent=!1,this.subscriber=e,this.assistant||(this.assistant=await this.getAssistant());let s=(g=t.threadId)!=null?g:z(),a=(o=(u=t.forwardedProps)==null?void 0:u.streamMode)!=null?o:["events","values","updates"],r=await this.prepareStream(y(m({},t),{threadId:s}),a);if(!r)return e.error("No stream to regenerate");await this.handleStreamEvents(r,s,e,t,Array.isArray(a)?a:[a])}async prepareRegenerateStream(t,e){var o,d,c;let{threadId:s,messageCheckpoint:a}=t,r=await this.getCheckpointByMessage(a.id,s);if(this.assistant||(this.assistant=await this.getAssistant()),!r)return this.subscriber.error("No checkpoint found for message");let g=await this.client.threads.updateState(s,{values:this.langGraphDefaultMergeState(r.values,[],t),checkpointId:r.checkpoint.checkpoint_id,asNode:(d=(o=r.next)==null?void 0:o[0])!=null?d:"__start__"}),u=y(m({},(c=t.forwardedProps)!=null?c:{}),{input:this.langGraphDefaultMergeState(r.values,[a],t),checkpointId:g.checkpoint.checkpoint_id,streamMode:e});return{streamResponse:this.client.runs.stream(s,this.assistant.assistant_id,u),state:r,streamMode:e}}async prepareStream(t,e){var Q,w,b,G,D,K,U,k,L,J;let{threadId:s,state:a,messages:r,tools:g,context:u,forwardedProps:o}=t;this.activeRun.manuallyEmittedState=null;let d=o==null?void 0:o.nodeName,c=s!=null?s:z();this.assistant||(this.assistant=await this.getAssistant());let l=await this.getOrCreateThread(c,o==null?void 0:o.threadMetadata);this.activeRun.threadId=l.thread_id;let f=(Q=await this.client.threads.getState(l.thread_id))!=null?Q:{values:{}},p=(w=f.values.messages)!=null?w:[],N=Y(r),T=this.langGraphDefaultMergeState(y(m({},a),{messages:p}),N,t),R=y(m({},f),{values:y(m({},T),{messages:[...p,...(b=T.messages)!=null?b:[]]})}),C=R.values;if(this.activeRun.schemaKeys=await this.getSchemaKeys(),((G=f.values.messages)!=null?G:[]).length>r.filter(S=>S.role!=="system").length){let S=null;for(let A=r.length-1;A>=0;A--)if(r[A].role==="user"){S=Y([r[A]])[0];break}return S?this.prepareRegenerateStream(y(m({},t),{messageCheckpoint:S}),e):this.subscriber.error("No user message found in messages to regenerate")}this.activeRun.graphInfo=await this.client.assistants.getGraph(this.assistant.assistant_id);let v=!((D=o==null?void 0:o.command)!=null&&D.resume)&&c&&this.activeRun.nodeName!="__end__"&&this.activeRun.nodeName?"continue":"start";if(v==="continue"){let S=this.activeRun.graphInfo.edges.find(A=>A.target===this.activeRun.nodeName);await this.client.threads.updateState(c,{values:a,asNode:S==null?void 0:S.source})}let x=ot({mode:v,state:C,schemaKeys:this.activeRun.schemaKeys}),_,F=[this.assistantConfig,o==null?void 0:o.config].filter(Boolean);F.length&&(_=await this.mergeConfigs({configs:F,assistant:this.assistant,schemaKeys:this.activeRun.schemaKeys}));let I=y(m({},o),{streamMode:e,input:x,config:_,context:m(m({},u),(K=_==null?void 0:_.configurable)!=null?K:{})}),M=(L=(k=(U=f.tasks)==null?void 0:U[0])==null?void 0:k.interrupts)!=null?L:[];return M!=null&&M.length&&!((J=o==null?void 0:o.command)!=null&&J.resume)?(this.dispatchEvent({type:h.RUN_STARTED,threadId:c,runId:t.runId}),this.handleNodeChange(d),M.forEach(S=>{this.dispatchEvent({type:h.CUSTOM,name:"on_interrupt",value:typeof S.value=="string"?S.value:JSON.stringify(S.value),rawEvent:S})}),this.dispatchEvent({type:h.RUN_FINISHED,threadId:c,runId:t.runId}),this.subscriber.complete()):{streamResponse:this.client.runs.stream(c,this.assistant.assistant_id,I),state:R}}async handleStreamEvents(t,e,s,a,r){var p,N,T,R,C,v,x,_,w,b,G,D,K,U;let{forwardedProps:g}=a,u=g==null?void 0:g.nodeName;this.subscriber=s;let o=!1;if(!t)return;let{streamResponse:d,state:c}=t;this.activeRun.prevNodeName=null;let l={},f=c,y=(this.activeRun==null?void 0:this.activeRun.threadStream)===!0;try{this.activeRun!=null&&this.activeRun.connectRunStarted||this.dispatchEvent({type:h.RUN_STARTED,threadId:e,runId:this.activeRun.id}),this.handleNodeChange(u);try{for(var F=rt(d),I,M,Q;I=!(M=await F.next()).done;I=!1){let E=M.value;if(this.cancelRequested&&!this.cancelSent&&((p=this.activeRun)!=null&&p.threadId)&&((N=this.activeRun)!=null&&N.id)){try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}try{await((T=d==null?void 0:d.return)==null?void 0:T.call(d))}catch(W){}break}let Z=(R=a.forwardedProps)==null?void 0:R.streamSubgraphs,gt=Z&&(E.event.startsWith("events")||E.event.startsWith("values"));if(!r.includes(E.event)&&!gt&&E.event!=="error")continue;let H=E;if(E.event==="error"){this.dispatchEvent({type:h.RUN_ERROR,message:E.data.message,rawEvent:E});break}if(E.event==="updates")continue;if(E.event==="values"){l=H.data;continue}else if(Z&&H.event.startsWith("values|")){l=m(m({},l),H.data);continue}let B=H.data,q=(C=B.metadata)!=null?C:{},O=q.langgraph_node,tt=B.event;if(q.run_id&&(this.activeRun.id=q.run_id,this.activeRun.serverRunIdKnown=!0,this.cancelRequested&&!this.cancelSent&&((v=this.activeRun)!=null&&v.threadId)))try{await this.client.runs.cancel(this.activeRun.threadId,this.activeRun.id)}catch(W){}finally{this.cancelSent=!0}if(O&&O!==this.activeRun.nodeName&&this.handleNodeChange(O),o=o||tt==="on_custom_event"&&B.name==="exit",tt==="on_chain_end"&&this.activeRun.nodeName===O&&(this.activeRun.exitingNode=!0),this.activeRun.exitingNode&&(this.activeRun.manuallyEmittedState=null),(x=this.activeRun.graphInfo)!=null&&x.nodes.some(W=>W.id===O)&&this.handleNodeChange(O),f.values=(_=this.activeRun.manuallyEmittedState)!=null?_:l,!this.activeRun.nodeName)continue;(JSON.stringify(f)!==JSON.stringify(c)||this.activeRun.prevNodeName!=this.activeRun.nodeName||this.activeRun.exitingNode)&&!this.getMessageInProgress(this.activeRun.id)&&(c=f,this.activeRun.prevNodeName=this.activeRun.nodeName,this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c),rawEvent:H})),this.dispatchEvent({type:h.RAW,event:B}),this.handleSingleEvent(B)}}catch(M){Q=[M]}finally{try{I&&(M=F.return)&&await M.call(F)}finally{if(Q)throw Q[0]}}c=await this.client.threads.getState(e);let k=c.tasks,L=(b=(w=k==null?void 0:k[0])==null?void 0:w.interrupts)!=null?b:[],J=c.next.length===0,S=(D=(G=c.metadata)==null?void 0:G.writes)!=null?D:{},A=this.activeRun.nodeName;return L!=null&&L.length||(A=J?"__end__":(K=c.next[0])!=null?K:Object.keys(S)[0]),L.forEach(E=>{this.dispatchEvent({type:h.CUSTOM,name:"on_interrupt",value:typeof E.value=="string"?E.value:JSON.stringify(E.value),rawEvent:E})}),this.handleNodeChange(A),this.handleNodeChange(void 0),this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot(c)}),this.dispatchEvent({type:h.MESSAGES_SNAPSHOT,messages:lt((U=c.values.messages)!=null?U:[])}),this.dispatchEvent({type:h.RUN_FINISHED,threadId:e,runId:this.activeRun.id}),this.cancelRequested=!1,this.cancelSent=!1,this.activeRun=void 0,y||s.complete()}catch(k){return s.error(k)}}handleSingleEvent(t){var e,s,a,r,g,u,o;switch(t.event){case"on_chat_model_stream":let d=(e=t.metadata["emit-messages"])!=null?e:!0,c=(s=t.metadata["emit-tool-calls"])!=null?s:!0;if(t.data.chunk.response_metadata.finish_reason)return;let l=this.getMessageInProgress(this.activeRun.id),f=!!(l!=null&&l.id),p=(a=t.data.chunk.tool_call_chunks)==null?void 0:a[0],N=(r=t.metadata.predict_state)==null?void 0:r.some(M=>M.tool===(p==null?void 0:p.name)),T=!f&&(p==null?void 0:p.name),R=f&&(l==null?void 0:l.toolCallId)&&(p==null?void 0:p.args),C=f&&(l==null?void 0:l.toolCallId)&&!p;(C||R||T)&&(this.activeRun.hasFunctionStreaming=!0);let v=ht(t.data),x=P(t.data.chunk.content),_=!!(!p&&x),F=f&&!(l!=null&&l.toolCallId)&&!_;if(v){this.handleThinkingEvent(v);break}if(!v&&this.thinkingProcess&&(this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:h.THINKING_END}),this.thinkingProcess=null),N&&this.dispatchEvent({type:h.CUSTOM,name:"PredictState",value:t.metadata.predict_state}),C){this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:l==null?void 0:l.toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(F){this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:l.id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if(T&&c){this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:p.id,toolCallName:p.name,parentMessageId:t.data.chunk.id,rawEvent:t})&&this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:p.id,toolCallName:p.name});break}if(R&&c){this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:l==null?void 0:l.toolCallId,delta:p.args,rawEvent:t});break}if(_&&d){l||(this.dispatchEvent({type:h.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.chunk.id,rawEvent:t}),this.setMessageInProgress(this.activeRun.id,{id:t.data.chunk.id,toolCallId:null,toolCallName:null}),l=this.getMessageInProgress(this.activeRun.id)),this.dispatchEvent({type:h.TEXT_MESSAGE_CONTENT,messageId:l.id,delta:x,rawEvent:t});break}break;case"on_chat_model_end":if((g=this.getMessageInProgress(this.activeRun.id))!=null&&g.toolCallId){this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:this.getMessageInProgress(this.activeRun.id).toolCallId,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}if((u=this.getMessageInProgress(this.activeRun.id))!=null&&u.id){this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:this.getMessageInProgress(this.activeRun.id).id,rawEvent:t})&&(this.messagesInProcess[this.activeRun.id]=null);break}break;case"on_custom_event":if(t.name==="manually_emit_message"){this.dispatchEvent({type:h.TEXT_MESSAGE_START,role:"assistant",messageId:t.data.message_id,rawEvent:t}),this.dispatchEvent({type:h.TEXT_MESSAGE_CONTENT,messageId:t.data.message_id,delta:t.data.message,rawEvent:t}),this.dispatchEvent({type:h.TEXT_MESSAGE_END,messageId:t.data.message_id,rawEvent:t});break}if(t.name==="manually_emit_tool_call"){this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:t.data.id,toolCallName:t.data.name,parentMessageId:t.data.id,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:t.data.id,delta:t.data.args,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:t.data.id,rawEvent:t});break}t.name==="manually_emit_state"&&(this.activeRun.manuallyEmittedState=t.data,this.dispatchEvent({type:h.STATE_SNAPSHOT,snapshot:this.getStateSnapshot({values:this.activeRun.manuallyEmittedState}),rawEvent:t})),this.dispatchEvent({type:h.CUSTOM,name:t.name,value:t.data,rawEvent:t});break;case"on_tool_end":let I=(o=t.data)==null?void 0:o.output;this.activeRun.hasFunctionStreaming||(this.dispatchEvent({type:h.TOOL_CALL_START,toolCallId:I.tool_call_id,toolCallName:I.name,parentMessageId:I.id,rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_ARGS,toolCallId:I.tool_call_id,delta:JSON.stringify(t.data.input),rawEvent:t}),this.dispatchEvent({type:h.TOOL_CALL_END,toolCallId:I.tool_call_id,rawEvent:t})),this.dispatchEvent({type:h.TOOL_CALL_RESULT,toolCallId:I.tool_call_id,content:I==null?void 0:I.content,messageId:z(),role:"tool"});break}}abortRun(){var s,a;this.cancelRequested=!0;let t=(s=this.activeRun)==null?void 0:s.threadId,e=(a=this.activeRun)==null?void 0:a.id;t&&e&&!this.cancelSent&&this.client.runs.cancel(t,e).then(()=>{this.cancelSent=!0}).catch(()=>{}),super.abortRun()}handleThinkingEvent(t){var s;if(!t||!t.type||!t.text)return;let e=t.index;(s=this.thinkingProcess)!=null&&s.index&&this.thinkingProcess.index!==e&&(this.thinkingProcess.type&&this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_END}),this.dispatchEvent({type:h.THINKING_END}),this.thinkingProcess=null),this.thinkingProcess||(this.dispatchEvent({type:h.THINKING_START}),this.thinkingProcess={index:e}),this.thinkingProcess.type!==t.type&&(this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_START}),this.thinkingProcess.type=t.type),this.thinkingProcess.type&&this.dispatchEvent({type:h.THINKING_TEXT_MESSAGE_CONTENT,delta:t.text})}getStateSnapshot(t){let e=t.values,s=this.activeRun.schemaKeys;return s!=null&&s.output&&(e=X(e,[...this.constantSchemaKeys,...s.output])),e}async getOrCreateThread(t,e){let s;try{try{s=await this.getThread(t)}catch(a){s=await this.createThread({threadId:t,metadata:e})}}catch(a){throw new Error(`Failed to create thread: ${a.message}`)}return s}async getThread(t){return this.client.threads.get(t)}async createThread(t){return this.client.threads.create(t)}async mergeConfigs({configs:t,assistant:e,schemaKeys:s}){return t.reduce((a,r)=>{var l;let g=a.configurable;r.configurable&&(g=s!=null&&s.config?X(r==null?void 0:r.configurable,[...this.constantSchemaKeys,...(l=s==null?void 0:s.config)!=null?l:[]]):r==null?void 0:r.configurable);let u=y(m(m({},a),r),{configurable:g}),o=a.recursion_limit==null&&r.recursion_limit===25,d=JSON.stringify(u)!==JSON.stringify(a),c=o&&JSON.stringify(y(m({},u),{recursion_limit:null}))===JSON.stringify(y(m({},a),{recursion_limit:null}));return d&&!c?m(m({},a),u):a},e.config)}getMessageInProgress(t){return this.messagesInProcess[t]}setMessageInProgress(t,e){this.messagesInProcess=y(m({},this.messagesInProcess),{[t]:m(m({},this.messagesInProcess[t]),e)})}async getAssistant(){try{let t=await this.client.assistants.search(),e=t.find(s=>s.graph_id===this.graphId);if(!e){let s=`
       No agent found with graph ID ${this.graphId} found..
 
 
       These are the available agents: [${t.map(a=>`${a.graph_id} (ID: ${a.assistant_id})`).join(", ")}]
-      `;throw console.error(s),new Error(s)}return e}catch(t){let e=new Error(`Failed to retrieve assistant: ${t.message}`);throw this.dispatchEvent({type:h.RUN_ERROR,message:e.message}),this.subscriber.error(),e}}async getSchemaKeys(){var t,e,s,a;try{let r=await this.client.assistants.getSchemas(this.assistant.assistant_id),g=null,u=[];if("context_schema"in r&&((t=r.context_schema)!=null&&t.properties)&&(u=Object.keys(r.context_schema.properties)),(e=r.config_schema)!=null&&e.properties&&(g=Object.keys(r.config_schema.properties)),!((s=r.input_schema)!=null&&s.properties)||!((a=r.output_schema)!=null&&a.properties))return{config:[],input:null,output:null,context:u};let o=Object.keys(r.input_schema.properties),d=Object.keys(r.output_schema.properties);return{input:o&&o.length?[...o,...this.constantSchemaKeys]:null,output:d&&d.length?[...d,...this.constantSchemaKeys]:null,context:u,config:g}}catch(r){return{config:[],input:this.constantSchemaKeys,output:this.constantSchemaKeys,context:[]}}}langGraphDefaultMergeState(t,e,s){var o,d;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let a=t.messages||[],r=new Set(a.map(c=>c.id)),g=e.filter(c=>!r.has(c.id)),u=[...(o=t.tools)!=null?o:[],...(d=s.tools)!=null?d:[]].reduce((c,l)=>{let f=l;return l.type||(f={type:"function",name:l.name,function:{name:l.name,description:l.description,parameters:l.parameters}}),c.find(p=>p.name===f.name||p.function.name===f.function.name)?c:[...c,f]},[]);return y(m({},t),{messages:g,tools:u,"ag-ui":{tools:u,context:s.context}})}handleNodeChange(t){var e,s;t==="__end__"&&(t=void 0),t!==((e=this.activeRun)==null?void 0:e.nodeName)&&((s=this.activeRun)!=null&&s.nodeName&&this.endStep(),t&&this.startStep(t)),this.activeRun.nodeName=t}startStep(t){this.dispatchEvent({type:h.STEP_STARTED,stepName:t})}endStep(){this.dispatchEvent({type:h.STEP_FINISHED,stepName:this.activeRun.nodeName})}async getCheckpointByMessage(t,e,s){var T,C;let a=s!=null&&s.checkpoint_id?{checkpoint:{checkpoint_id:s.checkpoint_id}}:void 0,g=[...await this.client.threads.getHistory(e,a)].reverse(),u=g.find(v=>{var x;return(x=v.values.messages)==null?void 0:x.some(_=>_.id===t)});if(!u)throw new Error("Message not found");let o=(T=u.values.messages)!=null?T:[],d=o.findIndex(v=>v.id===t);if(o.slice(d+1).length)return this.getCheckpointByMessage(t,e,u.parent_checkpoint);let l=g.indexOf(u),R=u.values,{messages:f}=R,p=it(R,["messages"]),N=(C=g[l-1])!=null?C:y(m({},u),{values:{}});return y(m({},N),{values:m(m({},N.values),p)})}};var ct=class extends Rt{};export{St as CustomEventNames,dt as LangGraphAgent,ft as LangGraphEventTypes,ct as LangGraphHttpAgent};
+      `;throw console.error(s),new Error(s)}return e}catch(t){let e=new Error(`Failed to retrieve assistant: ${t.message}`);throw this.dispatchEvent({type:h.RUN_ERROR,message:e.message}),this.subscriber.error(),e}}async getSchemaKeys(){var t,e,s,a;try{let r=await this.client.assistants.getSchemas(this.assistant.assistant_id),g=null,u=[];if("context_schema"in r&&((t=r.context_schema)!=null&&t.properties)&&(u=Object.keys(r.context_schema.properties)),(e=r.config_schema)!=null&&e.properties&&(g=Object.keys(r.config_schema.properties)),!((s=r.input_schema)!=null&&s.properties)||!((a=r.output_schema)!=null&&a.properties))return{config:[],input:null,output:null,context:u};let o=Object.keys(r.input_schema.properties),d=Object.keys(r.output_schema.properties);return{input:o&&o.length?[...o,...this.constantSchemaKeys]:null,output:d&&d.length?[...d,...this.constantSchemaKeys]:null,context:u,config:g}}catch(r){return{config:[],input:null,output:null,context:[]}}}langGraphDefaultMergeState(t,e,s){var o,d;e.length>0&&"role"in e[0]&&e[0].role==="system"&&(e=e.slice(1));let a=t.messages||[],r=new Set(a.map(c=>c.id)),g=e.filter(c=>!r.has(c.id)),u=[...(o=t.tools)!=null?o:[],...(d=s.tools)!=null?d:[]].reduce((c,l)=>{let f=l;return l.type||(f={type:"function",name:l.name,function:{name:l.name,description:l.description,parameters:l.parameters}}),c.find(p=>p.name===f.name||p.function.name===f.function.name)?c:[...c,f]},[]);return y(m({},t),{messages:g,tools:u,"ag-ui":{tools:u,context:s.context}})}handleNodeChange(t){var e,s;t==="__end__"&&(t=void 0),t!==((e=this.activeRun)==null?void 0:e.nodeName)&&((s=this.activeRun)!=null&&s.nodeName&&this.endStep(),t&&this.startStep(t)),this.activeRun.nodeName=t}startStep(t){this.dispatchEvent({type:h.STEP_STARTED,stepName:t})}endStep(){this.dispatchEvent({type:h.STEP_FINISHED,stepName:this.activeRun.nodeName})}async getCheckpointByMessage(t,e,s){var T,C;let a=s!=null&&s.checkpoint_id?{checkpoint:{checkpoint_id:s.checkpoint_id}}:void 0,g=[...await this.client.threads.getHistory(e,a)].reverse(),u=g.find(v=>{var x;return(x=v.values.messages)==null?void 0:x.some(_=>_.id===t)});if(!u)throw new Error("Message not found");let o=(T=u.values.messages)!=null?T:[],d=o.findIndex(v=>v.id===t);if(o.slice(d+1).length)return this.getCheckpointByMessage(t,e,u.parent_checkpoint);let l=g.indexOf(u),R=u.values,{messages:f}=R,p=it(R,["messages"]),N=(C=g[l-1])!=null?C:y(m({},u),{values:{}});return y(m({},N),{values:m(m({},N.values),p)})}};var ct=class extends Rt{};export{St as CustomEventNames,dt as LangGraphAgent,ft as LangGraphEventTypes,ct as LangGraphHttpAgent};
 //# sourceMappingURL=index.mjs.map
