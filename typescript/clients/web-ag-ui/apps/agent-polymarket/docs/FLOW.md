# Polymarket Agent - Complete Flow & Integration Guide

## Overview

The Polymarket Arbitrage Agent is an **autonomous trading system** that monitors prediction markets for **two types of arbitrage opportunities**:

1. **Intra-Market Arbitrage**: YES + NO prices sum to less than $1.00
2. **Cross-Market Arbitrage**: Logical relationships between markets are violated by pricing

The agent uses **LangGraph** for workflow orchestration, **LLM** (optional) for relationship detection, and integrates with Polymarket's Gamma, CLOB, and Data APIs.

---

## Table of Contents

1. [User Flow](#user-flow)
2. [Trading Cycle Flow](#trading-cycle-flow)
3. [LangGraph Workflow](#langgraph-workflow)
4. [Frontend Integration](#frontend-integration)
5. [Data Flow](#data-flow)
6. [State Management](#state-management)
7. [Environment Variables](#environment-variables)

---

## User Flow

### Phase 1: Discovery (Pre-Hire)

Users can view live market data without connecting a wallet:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    AGENT DISCOVERY PAGE                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ¯ Polymarket Arbitrage Agent                                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                             â”‚
â”‚                                                                   â”‚
â”‚  Strategy: Dual arbitrage (Intra-market + Cross-market)         â”‚
â”‚  Network: Polygon â€¢ Protocol: Polymarket CLOB                   â”‚
â”‚                                                                   â”‚
â”‚  Agent Stats:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ AUM      â”‚ â”‚ APY      â”‚ â”‚ Opps     â”‚ â”‚ Win Rate â”‚            â”‚
â”‚  â”‚ $50,000  â”‚ â”‚ 12.5%    â”‚ â”‚ 247      â”‚ â”‚ 94%      â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Live Opportunities (no wallet required)                      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Type          â”‚ Markets              â”‚ Spread â”‚ Profit      â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ Intra-Market  â”‚ Bitcoin $100k 2025   â”‚ 3.5% ğŸ”¥â”‚ $0.035/sh  â”‚ â”‚
â”‚  â”‚ Cross-Market  â”‚ Trump FL â†’ GOP FL    â”‚ 2.8% ğŸ”¥â”‚ $0.028/sh  â”‚ â”‚
â”‚  â”‚ Intra-Market  â”‚ ETH $5k by Dec       â”‚ 2.1% ğŸ”¥â”‚ $0.021/sh  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚  [        HIRE AGENT        ]                                    â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Phase 2: Onboarding (Hire Flow)

When user clicks "Hire", the agent starts a **multi-step onboarding**:

```
Step 1: Wallet Connection
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connect Polygon Wallet                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â”‚
â”‚  Please connect your wallet to get started.      â”‚
â”‚                                                  â”‚
â”‚  [  Connect Wallet  ]                            â”‚
â”‚                                                  â”‚
â”‚  Once connected, you'll approve USDC spending    â”‚
â”‚  and CTF token transfers (gasless signature +    â”‚
â”‚  one-time gas transaction).                      â”‚
â”‚                                                  â”‚
â”‚  [  Next  ]                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: USDC Approval (EIP-2612 Permit - Gasless)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Approve USDC Spending                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  The agent needs permission to spend USDC.       â”‚
â”‚                                                  â”‚
â”‚  Approval Amount:                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1000 USDC                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  â„¹ï¸  This is a gasless signature (EIP-2612)     â”‚
â”‚     No gas fees required!                       â”‚
â”‚                                                  â”‚
â”‚  [  Sign Permit  ]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: CTF Approval (Standard ERC-20 - Requires Gas)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Approve CTF Tokens                               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                              â”‚
â”‚  The exchange needs permission to transfer CTF   â”‚
â”‚  tokens (YES/NO outcome tokens).                 â”‚
â”‚                                                  â”‚
â”‚  â›½ Estimated Gas: ~0.0001 MATIC ($0.02)         â”‚
â”‚                                                  â”‚
â”‚  [  Approve CTF  ]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 4: Configure Strategy
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strategy Settings                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚                                                  â”‚
â”‚  ğŸ“Š Risk Management                              â”‚
â”‚  â€¢ Max position size: $100                       â”‚
â”‚  â€¢ Portfolio risk %: 3%                          â”‚
â”‚  â€¢ Max total exposure: $500                      â”‚
â”‚                                                  â”‚
â”‚  ğŸ¯ Opportunity Filters                          â”‚
â”‚  â€¢ Min spread (intra): 2%                        â”‚
â”‚  â€¢ Min profit (cross): $0.01                     â”‚
â”‚  â€¢ Max slippage: 5%                              â”‚
â”‚                                                  â”‚
â”‚  ğŸ¤– Detection Settings                           â”‚
â”‚  â–¡ Enable LLM relationship detection             â”‚
â”‚     (more comprehensive, slower, costs $0.01-0.05)â”‚
â”‚  â–¡ Enable manual trade approval                  â”‚
â”‚     (review trades before execution)             â”‚
â”‚                                                  â”‚
â”‚  [  Start Agent  ]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Approval Flow Details**:
1. **USDC Permit**: Gasless signature (EIP-2612), allows agent to spend USDC
2. **CTF Approval**: One-time gas transaction, allows exchange to transfer outcome tokens
3. Both approvals are checked before every trade and only requested once

---

### Phase 3: Running (Active Trading)

Once hired and approved, the agent enters the **running state**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¯ Polymarket Arbitrage              [Running] â¬¤  Cycle #42   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”               â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Portfolio    â”‚ â”‚ Total P&L    â”‚ â”‚ Active       â”‚              â”‚
â”‚  â”‚ $1,105.42    â”‚ â”‚ +$105.42     â”‚ â”‚ Positions: 8 â”‚              â”‚
â”‚  â”‚              â”‚ â”‚ (10.5%)      â”‚ â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                   â”‚
â”‚  [Opportunities] [Relationships] [Positions] [History] [Settings]â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•          â”‚
â”‚                                                                   â”‚
â”‚  Current Opportunities (Sorted by Profit)                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Type    â”‚ Markets                  â”‚ Profit  â”‚ ROI  â”‚ Act â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ Cross ğŸ”—â”‚ Bitcoin Q1â†’2025          â”‚ $0.25   â”‚ 33% ğŸ”¥â”‚ âš¡ â”‚  â”‚
â”‚  â”‚ Intra â—† â”‚ ETH $5k by Dec           â”‚ $0.035  â”‚ 3.5%ğŸ”¥â”‚ âš¡ â”‚  â”‚
â”‚  â”‚ Cross ğŸ”—â”‚ Trump FLâ†’GOP FL          â”‚ $0.028  â”‚ 4%  ğŸ”¥â”‚ âš¡ â”‚  â”‚
â”‚  â”‚ Intra â—† â”‚ S&P 6000 by 2025         â”‚ $0.021  â”‚ 2.1% â”‚    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  Detected Relationships (LLM + Patterns)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Type        â”‚ Markets                     â”‚ Status        â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ IMPLIES     â”‚ Trump wins FL â†’ GOP wins FL â”‚ Violation ğŸ”¥  â”‚  â”‚
â”‚  â”‚ IMPLIES     â”‚ BTC Q1 2025 â†’ BTC 2025      â”‚ Violation ğŸ”¥  â”‚  â”‚
â”‚  â”‚ MUTUAL_EXCL â”‚ Dem wins FL âŠ• GOP wins FL   â”‚ Valid âœ“       â”‚  â”‚
â”‚  â”‚ EQUIVALENCE â”‚ ETH $5k â†” ETH hits $5k      â”‚ Valid âœ“       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  Recent Activity                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â— Cycle 42: Found 4 opps (2 intra, 2 cross), executed 3  â”‚   â”‚
â”‚  â”‚ â— Cycle 41: Synced positions, unrealized P&L: +$12.50    â”‚   â”‚
â”‚  â”‚ â— Cycle 40: Redeemed 2 resolved markets, +$24.00         â”‚   â”‚
â”‚  â”‚ â— Cycle 39: Found 1 opp (cross), executed 1              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  [  Sync Positions  ]  [  Redeem Resolved  ]  [  Fire Agent  ]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key UI Sections**:
- **Opportunities**: Live intra-market + cross-market arbitrage opportunities
- **Relationships**: Detected logical relationships (IMPLIES, REQUIRES, MUTUAL_EXCLUSION, EQUIVALENCE)
- **Positions**: Current YES/NO token holdings with P&L
- **History**: Transaction log with trade details
- **Settings**: Adjust risk parameters, LLM toggle, manual approval mode

---

### Phase 4: Manual Approval Mode (Optional)

If `POLY_MANUAL_APPROVAL=true`, users review trades before execution:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”” Pending Trades (Awaiting Your Approval)                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                      â”‚
â”‚                                                                   â”‚
â”‚  Opportunity #1: Cross-Market (IMPLIES)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Markets:                                                   â”‚   â”‚
â”‚  â”‚   Parent: "Bitcoin hits $100k in Q1 2025" @ $0.60 (sell) â”‚   â”‚
â”‚  â”‚   Child:  "Bitcoin hits $100k in 2025" @ $0.35 (buy)     â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ Position:                                                 â”‚   â”‚
â”‚  â”‚   Shares: 40                                              â”‚   â”‚
â”‚  â”‚   Sell cost: $16.00 (buy NO at $0.40)                    â”‚   â”‚
â”‚  â”‚   Buy cost: $14.00                                        â”‚   â”‚
â”‚  â”‚   Total: $30.00                                           â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ Expected:                                                 â”‚   â”‚
â”‚  â”‚   Profit: $10.00                                          â”‚   â”‚
â”‚  â”‚   ROI: 33.3%                                              â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ Expires in: 28 seconds                                    â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ [  Approve  ]  [  Reject  ]                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  Opportunity #2: Intra-Market                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Market: "Ethereum price above $5000 in 2025"              â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ Position:                                                 â”‚   â”‚
â”‚  â”‚   YES shares: 31 @ $0.48 = $14.88                        â”‚   â”‚
â”‚  â”‚   NO shares: 31 @ $0.48 = $14.88                         â”‚   â”‚
â”‚  â”‚   Total: $29.76                                           â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ Expected:                                                 â”‚   â”‚
â”‚  â”‚   Profit: $1.24 (when market resolves)                   â”‚   â”‚
â”‚  â”‚   ROI: 4.2%                                               â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ Expires in: 25 seconds                                    â”‚   â”‚
â”‚  â”‚                                                           â”‚   â”‚
â”‚  â”‚ [  Approve  ]  [  Reject  ]                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                   â”‚
â”‚  [  Approve All  ]  [  Reject All  ]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Notes**:
- Pending trades expire after 30 seconds (prices change quickly)
- User can approve/reject individual trades or all at once
- After approval, agent executes immediately

---

## Trading Cycle Flow

Each cycle (default: every 30 seconds) follows this flow:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CYCLE START (Iteration #42)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CHECK APPROVALS                                               â”‚
â”‚    â”œâ”€ Check USDC permit signature                                â”‚
â”‚    â”œâ”€ Check CTF approval transaction                             â”‚
â”‚    â””â”€ Halt if approvals missing (prompt user)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. FETCH MARKETS (Parallel)                                      â”‚
â”‚    â”œâ”€ Gamma API: Get 50 markets (rotating offset)                â”‚
â”‚    â”œâ”€ For each market:                                           â”‚
â”‚    â”‚  â”œâ”€ CLOB API: Get YES/NO buy prices                         â”‚
â”‚    â”‚  â”œâ”€ CLOB API: Get order book (liquidity, min order size)    â”‚
â”‚    â”‚  â””â”€ Cache market data                                       â”‚
â”‚    â”œâ”€ Data API: Get user positions (size, value, P&L)            â”‚
â”‚    â”œâ”€ Data API: Get trading history (last 50 trades)             â”‚
â”‚    â””â”€ Calculate portfolio value from positions                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SCAN INTRA-MARKET OPPORTUNITIES                               â”‚
â”‚    â”œâ”€ For each market:                                           â”‚
â”‚    â”‚  â””â”€ Check: yesPrice + noPrice < 1.0 - threshold            â”‚
â”‚    â”œâ”€ Filter by:                                                 â”‚
â”‚    â”‚  â”œâ”€ Min spread (default: 2%)                                â”‚
â”‚    â”‚  â”œâ”€ Exposure limits                                         â”‚
â”‚    â”‚  â””â”€ Liquidity                                               â”‚
â”‚    â””â”€ Sort by profit potential (highest first)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DETECT RELATIONSHIPS                                          â”‚
â”‚    â”‚                                                              â”‚
â”‚    â”œâ”€ If LLM enabled (POLY_USE_LLM_DETECTION=true):              â”‚
â”‚    â”‚  â”œâ”€ Limit to POLY_LLM_MAX_MARKETS (default: 25)             â”‚
â”‚    â”‚  â”œâ”€ Build batch prompt with all market pairs                â”‚
â”‚    â”‚  â”œâ”€ Call OpenAI (model: gpt-4o or gpt-4o-mini)              â”‚
â”‚    â”‚  â”œâ”€ Timeout: 120 seconds                                    â”‚
â”‚    â”‚  â”œâ”€ Parse response (Zod schema validation)                  â”‚
â”‚    â”‚  â””â”€ Fallback to patterns if timeout/error                   â”‚
â”‚    â”‚                                                              â”‚
â”‚    â””â”€ If LLM disabled (pattern matching):                        â”‚
â”‚       â”œâ”€ For each market pair:                                   â”‚
â”‚       â”‚  â””â”€ Match against 40+ regex patterns                     â”‚
â”‚       â””â”€ Return detected relationships                           â”‚
â”‚                                                                   â”‚
â”‚    Relationship Types:                                           â”‚
â”‚    â€¢ IMPLIES (A â†’ B): If A happens, B must happen                â”‚
â”‚    â€¢ REQUIRES (A â† B): A requires B to happen first              â”‚
â”‚    â€¢ MUTUAL_EXCLUSION (A âŠ• B): Both can't happen                 â”‚
â”‚    â€¢ EQUIVALENCE (A â†” B): Same event, different phrasing         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. SCAN CROSS-MARKET OPPORTUNITIES                               â”‚
â”‚    â”œâ”€ For each relationship:                                     â”‚
â”‚    â”‚  â”œâ”€ Check price violation:                                  â”‚
â”‚    â”‚  â”‚  â”œâ”€ IMPLIES/REQUIRES: P(parent) > P(child) + 0.01        â”‚
â”‚    â”‚  â”‚  â”œâ”€ MUTUAL_EXCL: P(A) + P(B) > 1.005                     â”‚
â”‚    â”‚  â”‚  â””â”€ EQUIVALENCE: |P(A) - P(B)| > 0.05                    â”‚
â”‚    â”‚  â””â”€ Create CrossMarketOpportunity if violated               â”‚
â”‚    â”œâ”€ Filter by:                                                 â”‚
â”‚    â”‚  â”œâ”€ Min profit per share ($0.005)                           â”‚
â”‚    â”‚  â”œâ”€ Min liquidity ($1,000 if available)                     â”‚
â”‚    â”‚  â””â”€ Resolution timing (max 30 days difference)              â”‚
â”‚    â””â”€ Sort by expected profit per share                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. COMBINE & PRIORITIZE OPPORTUNITIES                            â”‚
â”‚    â”œâ”€ Merge intra-market + cross-market opportunities            â”‚
â”‚    â”œâ”€ Sort all by profit potential (highest first)               â”‚
â”‚    â””â”€ Take top N (default: 3, or all if EXECUTE_ALL=true)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ Manual Mode â”‚   â”‚  Auto Mode  â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. POSITION SIZING & EXECUTION                                   â”‚
â”‚                                                                   â”‚
â”‚ For Intra-Market:                                                â”‚
â”‚    â”œâ”€ Budget = min(portfolio * risk%, maxPositionSize)           â”‚
â”‚    â”œâ”€ Shares = floor(budget / (yesPrice + noPrice))              â”‚
â”‚    â”œâ”€ Check: shares >= minOrderSize (from CLOB API)              â”‚
â”‚    â”œâ”€ Check: expectedProfit >= minProfit ($0.01)                 â”‚
â”‚    â”œâ”€ Check: ROI >= 1%                                           â”‚
â”‚    â”œâ”€ Balance check: USDC >= totalCost * 1.05 (5% buffer)        â”‚
â”‚    â””â”€ Execute:                                                   â”‚
â”‚       â”œâ”€ adapter.createLongPosition() â†’ YES order                â”‚
â”‚       â””â”€ adapter.createShortPosition() â†’ NO order                â”‚
â”‚                                                                   â”‚
â”‚ For Cross-Market:                                                â”‚
â”‚    â”œâ”€ Cost/share = (1 - sellPrice) + buyPrice                    â”‚
â”‚    â”œâ”€ Budget = min(portfolio * risk%, maxPositionSize)           â”‚
â”‚    â”œâ”€ Max shares (budget) = floor(budget / costPerShare)         â”‚
â”‚    â”œâ”€ Max shares (liquidity) = floor(minLiq * 5% / costPerShare) â”‚
â”‚    â”œâ”€ Shares = min(budgetShares, liquidityShares)                â”‚
â”‚    â”œâ”€ Check: shares >= minOrderSize                              â”‚
â”‚    â”œâ”€ Check: expectedProfit >= minProfit                         â”‚
â”‚    â”œâ”€ Check: slippage <= maxSlippage (5%)                        â”‚
â”‚    â”œâ”€ Balance check: USDC >= netCost * 1.05                      â”‚
â”‚    â””â”€ Execute:                                                   â”‚
â”‚       â”œâ”€ adapter.placeOrder() â†’ Buy opposite on overpriced       â”‚
â”‚       â””â”€ adapter.placeOrder() â†’ Buy underpriced                  â”‚
â”‚                                                                   â”‚
â”‚ Paper Trading Mode (POLY_PAPER_TRADING=true):                   â”‚
â”‚    â”œâ”€ Skip actual execution                                      â”‚
â”‚    â”œâ”€ Create simulated Transaction[] with status='simulated'     â”‚
â”‚    â””â”€ Update metrics as if executed                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. SUMMARIZE CYCLE                                               â”‚
â”‚    â”œâ”€ Aggregate metrics (opportunitiesFound, tradesExecuted)     â”‚
â”‚    â”œâ”€ Create summary event for frontend                          â”‚
â”‚    â””â”€ Update iteration counter                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ Every 5th?  â”‚   â”‚ Every 10th? â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚ Sync Pos    â”‚   â”‚ Redeem      â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. SYNC POSITIONS (every 5th cycle)                             â”‚
â”‚    â”œâ”€ Data API: getPositions(userWalletAddress)                  â”‚
â”‚    â”œâ”€ Update userPositions in state                              â”‚
â”‚    â””â”€ Calculate unrealizedPnl from positions                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. REDEEM POSITIONS (every 10th cycle)                         â”‚
â”‚    â”œâ”€ Data API: getPositions(userWalletAddress)                  â”‚
â”‚    â”œâ”€ Filter: outcome != 'null' (resolved markets)               â”‚
â”‚    â”œâ”€ For each resolved position:                                â”‚
â”‚    â”‚  â”œâ”€ adapter.redeemPosition()                                â”‚
â”‚    â”‚  â””â”€ Convert CTF tokens â†’ USDC                               â”‚
â”‚    â””â”€ Update realizedPnl                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. WAIT & LOOP (if POLY_CONTINUOUS_POLLING=true)               â”‚
â”‚    â”œâ”€ Wait POLY_POLL_INTERVAL_MS (default: 30s)                  â”‚
â”‚    â””â”€ Loop back to Step 1                                        â”‚
â”‚                                                                   â”‚
â”‚    OR END (if continuous polling disabled, wait for cron)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## LangGraph Workflow

The agent uses **LangGraph** for state management and workflow orchestration:

### Workflow Graph

```
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚    START     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  runCommand  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
                                 â”‚                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
                    â”‚                         â”‚     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   hireCommand      â”‚    â”‚  cycleCommand      â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
         â”‚    bootstrap       â”‚              â”‚
         â”‚                    â”‚              â”‚
         â”‚  â€¢ Load creds      â”‚              â”‚
         â”‚  â€¢ Init wallet     â”‚              â”‚
         â”‚  â€¢ lifecycleState  â”‚              â”‚
         â”‚    â†’ 'running'     â”‚              â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
                    â”‚                        â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ checkApprovals  â”‚  â”‚  syncState  â”‚
   â”‚                 â”‚  â”‚             â”‚
   â”‚ â€¢ USDC permit   â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ â€¢ CTF approval  â”‚       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
            â”‚                â”‚
            â”‚                â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
   â”‚   pollCycle     â”‚       â”‚
   â”‚                 â”‚       â”‚
   â”‚ â€¢ Fetch markets â”‚       â”‚
   â”‚ â€¢ Detect rels   â”‚       â”‚
   â”‚ â€¢ Scan opps     â”‚       â”‚
   â”‚ â€¢ Execute       â”‚       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
            â”‚                â”‚
      â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”          â”‚
      â”‚           â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Manual?   â”‚  â”‚   summarize    â”‚
â”‚ Pending   â”‚  â”‚                â”‚
â”‚ Trades?   â”‚  â”‚ â€¢ Aggregate    â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ Update       â”‚
      â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                â”‚
â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚ collect   â”‚   â”‚             â”‚
â”‚ Trade     â”‚ â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Approval  â”‚ â”‚ syncPos   â”‚ â”‚ redeemPos  â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â”‚ (5th)     â”‚ â”‚ (10th)     â”‚
      â”‚       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚             â”‚               â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  END
                                                  â”‚
                                                  â”‚
                                    (continuous   â”‚
                                     polling      â”‚
                                     loops back)  â”‚
```

### Key Nodes

| Node | Purpose | Triggers |
|------|---------|----------|
| `runCommand` | Command dispatcher | Frontend/Cron calls |
| `hireCommand` | Agent activation | User clicks "Hire" |
| `bootstrap` | Load credentials, init wallet | After hire |
| `checkApprovals` | Verify USDC permit + CTF approval | Before each cycle |
| `pollCycle` | **Main trading loop** | Every cycle |
| `collectTradeApproval` | Manual trade approval | If pending trades exist |
| `summarize` | Aggregate cycle results | After pollCycle |
| `syncPositions` | Fetch real positions | Every 5th cycle |
| `redeemPositions` | Auto-redeem resolved markets | Every 10th cycle |
| `waitAndLoop` | Wait then loop back | Continuous polling mode |

### Conditional Routing

```typescript
// From: runCommand
switch (command) {
  case 'hire': â†’ hireCommand
  case 'fire': â†’ fireCommand
  case 'cycle': â†’ runCycleCommand
  case 'sync': â†’ syncState
  case 'updateApproval': â†’ updateApprovalCommand
}

// From: bootstrap
if (lifecycleState === 'running'):
  â†’ checkApprovals
else:
  â†’ syncState

// From: pollCycle
if (pendingTrades.length > 0):
  â†’ collectTradeApproval
else:
  â†’ summarize

// From: summarize
if (iteration % 5 === 0):
  â†’ syncPositions
elif (iteration % 10 === 0):
  â†’ redeemPositions
elif (continuousPolling && running):
  â†’ waitAndLoop
else:
  â†’ END
```

---

## Frontend Integration

### Component Hierarchy

```
PolymarketAgentPage
â”œâ”€â”€ AgentHeader (Status, P&L, Portfolio Value)
â”œâ”€â”€ TabNavigation
â”‚   â”œâ”€â”€ OpportunitiesTab
â”‚   â”‚   â”œâ”€â”€ IntraMarketOpportunities
â”‚   â”‚   â””â”€â”€ CrossMarketOpportunities
â”‚   â”œâ”€â”€ RelationshipsTab
â”‚   â”‚   â””â”€â”€ RelationshipsTable
â”‚   â”œâ”€â”€ PositionsTab
â”‚   â”‚   â”œâ”€â”€ UserPositionsTable (from Polymarket Data API)
â”‚   â”‚   â””â”€â”€ PortfolioSummary
â”‚   â”œâ”€â”€ TransactionsTab
â”‚   â”‚   â”œâ”€â”€ AgentTransactionHistory
â”‚   â”‚   â””â”€â”€ RealTradingHistory (from Polymarket Data API)
â”‚   â””â”€â”€ SettingsTab
â”‚       â”œâ”€â”€ RiskManagement
â”‚       â”œâ”€â”€ OpportunityFilters
â”‚       â”œâ”€â”€ DetectionSettings (LLM toggle)
â”‚       â””â”€â”€ ApprovalSettings
â”œâ”€â”€ PendingTradesModal (if manual approval mode)
â””â”€â”€ AgentControls (Sync, Redeem, Fire)
```

### Key Components

#### 1. OpportunityCard

```tsx
interface OpportunityCardProps {
  type: 'intra-market' | 'cross-market';
  opportunity: ArbitrageOpportunity | CrossMarketOpportunity;
  onExecute?: () => void;
}

// Displays:
// - Market title(s)
// - Prices (YES/NO or parent/child)
// - Spread/violation severity
// - Expected profit & ROI
// - Execute button (if auto mode)
```

#### 2. RelationshipsTable

```tsx
interface RelationshipsTableProps {
  relationships: MarketRelationship[];
  opportunities: CrossMarketOpportunity[];
}

// Displays:
// - Relationship type (IMPLIES, REQUIRES, etc.)
// - Parent/child markets
// - Current prices
// - Violation status (Valid/Violation)
// - Confidence score
// - Reasoning (from LLM)
```

#### 3. PositionsTable

```tsx
interface PositionsTableProps {
  userPositions: UserPosition[];  // From Polymarket Data API
  onClose?: (position: Position) => void;
}

// Displays:
// - Market title
// - Side (YES/NO)
// - Size (shares)
// - Cost basis
// - Current value
// - Unrealized P&L
// - Outcome (if resolved)
```

#### 4. PendingTradeApprovalModal

```tsx
interface PendingTradeApprovalModalProps {
  pendingTrades: PendingTrade[];
  onApprove: (tradeId: string) => void;
  onReject: (tradeId: string) => void;
}

// Displays:
// - Trade type (intra/cross)
// - Markets involved
// - Position sizing (shares, costs)
// - Expected profit & ROI
// - Expiration countdown
// - Approve/Reject buttons
```

### State Synchronization

The frontend uses **CopilotKit** to sync with LangGraph state:

```typescript
const { state } = useCopilotKitState<PolymarketState>();

// Access agent state:
const markets = state.view.markets;
const opportunities = state.view.opportunities;
const crossOpportunities = state.view.crossMarketOpportunities;
const relationships = state.view.detectedRelationships;
const userPositions = state.view.userPositions;
const tradingHistory = state.view.tradingHistory;
const portfolioValue = state.view.portfolioValueUsd;
const metrics = state.view.metrics;
const approvalStatus = state.view.approvalStatus;
const pendingTrades = state.view.pendingTrades;

// Send commands:
const { runCommand } = useCopilotKitCommands();
await runCommand('cycle');  // Trigger cycle
await runCommand('sync');   // Sync state
await runCommand('fire');   // Stop agent
```

---

## Data Flow

### Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend   â”‚â”€â”€â”€â”€â–¶â”‚   LangGraph      â”‚â”€â”€â”€â”€â–¶â”‚   Polymarket    â”‚
â”‚   (Next.js)  â”‚     â”‚   Agent          â”‚     â”‚   APIs          â”‚
â”‚              â”‚â—€â”€â”€â”€â”€â”‚   (TypeScript)   â”‚â—€â”€â”€â”€â”€â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                     â”‚                        â”‚
       â”‚                     â”‚                        â”‚
       â–¼                     â–¼                        â–¼
  User Actions          Agent State              API Data
  - Hire/Fire           - Lifecycle              - Markets (Gamma)
  - Approve trades      - Opportunities          - Prices (CLOB)
  - Configure           - Positions              - Orders (CLOB)
  - View metrics        - Transactions           - Positions (Data)
                        - Relationships          - History (Data)
                        - Approvals
```

### API Endpoints

#### Polymarket APIs

1. **Gamma API** (`https://gamma-api.polymarket.com`)
   - `GET /markets?chainIds[]=137&status=active&offset=0&limit=50`
   - Returns: Market metadata, tokens, end dates

2. **CLOB API** (`https://clob.polymarket.com`)
   - `GET /price?token_id={yesTokenId}&side=BUY`
   - `GET /book?token_id={yesTokenId}`
   - `POST /order` (requires auth signature)
   - `GET /order/{orderId}`
   - Returns: Prices, order book, order status

3. **Data API** (`https://data-api.polymarket.com`)
   - `GET /positions?user={address}`
   - `GET /history?user={address}&limit=50`
   - Returns: User positions, trading history

#### LLM API

4. **OpenAI API** (`https://api.openai.com/v1/chat/completions`)
   - Model: `gpt-4o` or `gpt-4o-mini`
   - Used for: Batch relationship detection
   - Cost: ~$0.01-0.05 per cycle (if enabled)

---

## State Management

### State Schema

```typescript
{
  messages: Messages[];           // LangGraph conversation
  copilotkit: { actions, context },
  view: {                         // Frontend-visible
    // Lifecycle
    lifecycleState: 'disabled' | 'waiting-funds' | 'running' | 'stopping' | 'stopped',
    command: string,
    task: Task,

    // Market Data
    markets: Market[],
    opportunities: ArbitrageOpportunity[],
    crossMarketOpportunities: CrossMarketOpportunity[],
    detectedRelationships: MarketRelationship[],

    // Positions & History
    positions: Position[],                 // Calculated
    userPositions: UserPosition[],         // From API
    transactionHistory: Transaction[],     // Agent-generated
    tradingHistory: TradingHistoryItem[], // From API
    portfolioValueUsd: number,

    // Pending Trades
    pendingTrades?: PendingTrade[],

    // Metrics
    metrics: {
      iteration: number,
      lastPoll: string,
      totalPnl: number,
      realizedPnl: number,
      unrealizedPnl: number,
      activePositions: number,
      opportunitiesFound: number,
      opportunitiesExecuted: number,
      tradesExecuted: number,
      tradesFailed: number,
    },

    // Configuration
    config: StrategyConfig,

    // Approvals
    approvalStatus: { usdc, ctf },
    needsUsdcPermitSignature: boolean,
    usdcPermitTypedData: EIP712TypedData,
    needsCtfApprovalTransaction: boolean,
    ctfApprovalTransaction: ApprovalTransaction,

    // Events
    events: PolymarketEvent[],
  },
  private: {                      // Internal only
    walletAddress: string,
    userWalletAddress: string,
    privateKey: string,
    bootstrapped: boolean,
  },
}
```

### State Merge Logic

```typescript
// Arrays that APPEND (incremental):
- transactionHistory
- events

// Arrays that REPLACE (complete snapshot):
- markets
- opportunities
- crossMarketOpportunities
- detectedRelationships
- userPositions
- tradingHistory
```

---

## Environment Variables

### Essential (Required)

| Variable | Description | Example |
|----------|-------------|---------|
| `POLY_PRIVATE_KEY` | Backend wallet private key | `0x123...` |
| `POLY_FUNDER_ADDRESS` | Backend wallet address | `0xabc...` |
| `POLY_USER_WALLET_ADDRESS` | Frontend wallet address | `0xdef...` |
| `OPENAI_API_KEY` | OpenAI API key (if LLM enabled) | `sk-...` |

### Strategy Configuration

| Variable | Default | Description |
|----------|---------|-------------|
| `POLY_MIN_SPREAD_THRESHOLD` | `0.02` | Min intra-market spread (2%) |
| `POLY_MIN_PROFIT_USD` | `0.01` | Min profit per trade ($0.01) |
| `POLY_MAX_POSITION_SIZE_USD` | `100` | Max capital per trade |
| `POLY_PORTFOLIO_RISK_PCT` | `3` | Portfolio risk % per trade |
| `POLY_MAX_TOTAL_EXPOSURE_USD` | `500` | Total capital limit |
| `POLY_MIN_SHARE_SIZE` | `5` | Fallback min share size |

### Detection Settings

| Variable | Default | Description |
|----------|---------|-------------|
| `POLY_USE_LLM_DETECTION` | `false` | Enable LLM relationship detection |
| `POLY_LLM_MODEL` | `gpt-4o-mini` | LLM model (gpt-4o, gpt-4o-mini) |
| `POLY_LLM_MAX_MARKETS` | `25` | Max markets to send to LLM |

### Execution Controls

| Variable | Default | Description |
|----------|---------|-------------|
| `POLY_MAX_OPPORTUNITIES_PER_CYCLE` | `3` | Max trades per cycle |
| `POLY_EXECUTE_ALL_OPPORTUNITIES` | `false` | Execute all viable opps |
| `POLY_MANUAL_APPROVAL` | `false` | Enable manual trade approval |
| `POLY_PAPER_TRADING` | `false` | Simulate trades (no execution) |
| `POLY_BYPASS_EXPOSURE_CHECK` | `false` | Bypass exposure limits (testing) |

### Polling & Lifecycle

| Variable | Default | Description |
|----------|---------|-------------|
| `POLY_POLL_INTERVAL_MS` | `30000` | Polling interval (30 seconds) |
| `POLY_CONTINUOUS_POLLING` | `false` | Loop continuously vs cron-driven |
| `POLY_MAX_ITERATIONS` | `0` | Max cycles (0 = unlimited) |
| `POLY_SYNC_POSITIONS` | `true` | Sync positions every 5th cycle |
| `POLY_AUTO_REDEEM` | `false` | Auto-redeem every 10th cycle |
| `POLY_KILL_SWITCH` | `false` | Emergency stop |

### Market Fetching

| Variable | Default | Description |
|----------|---------|-------------|
| `POLY_MARKET_FETCH_LIMIT` | `50` | Markets to fetch from Gamma |
| `POLY_MAX_MARKETS` | `50` | Markets to analyze per cycle |
| `POLY_MARKET_OFFSET` | `0` | Initial offset (rotates automatically) |

### Testing

| Variable | Default | Description |
|----------|---------|-------------|
| `POLYMARKET_USE_MOCK_DATA` | `false` | Use mock data (testing) |
| `LOG_LEVEL` | `info` | Logging level (debug, info, warn, error) |

---

## Quick Start

### 1. Setup Environment

```bash
# Copy example env
cp .env.example .env

# Configure required variables
POLY_PRIVATE_KEY=0x...
POLY_FUNDER_ADDRESS=0x...
POLY_USER_WALLET_ADDRESS=0x...
OPENAI_API_KEY=sk-...  # Optional, for LLM detection
```

### 2. Install Dependencies

```bash
pnpm install
```

### 3. Run Agent

```bash
# Development mode (with hot reload)
pnpm dev

# Start LangGraph server on port 8127
```

### 4. Test via Frontend

```bash
# In separate terminal, start web app
cd apps/web
pnpm dev

# Navigate to:
http://localhost:3000/hire-agents/agent-polymarket

# Click "Hire" and follow onboarding flow
```

### 5. Monitor Activity

```bash
# Watch agent logs
tail -f logs/polymarket-agent.log

# View cycle output
# Shows: markets fetched, opportunities found, trades executed
```

---

## Testing & Debugging

### View Mock Data

```bash
# Decode and display mock file
pnpm view:mock squid squid-route-1-137-0xa0b86...

# Service: squid, dune, birdeye, polymarket
# Mock name: filename without .json
```

### Run Specific Tests

```bash
# Unit tests
pnpm test:unit

# Integration tests
pnpm test:int

# Specific file
pnpm test:int tests/scanner.int.test.ts

# Specific test
pnpm test:int -t "should detect IMPLIES relationship"
```

### Record New Mocks

```bash
# Record real API responses
pnpm test:record-mocks

# Requires API keys in .env
# Saves to tests/mocks/data/
```

### Debug Failing Tests

```bash
# Show console logs during tests
LOG_LEVEL=debug pnpm test:int

# Show errors only
LOG_LEVEL=error pnpm test:int
```

---

## Troubleshooting

### Agent Not Finding Opportunities

**Check**:
1. Market fetch limit: `POLY_MAX_MARKETS` (increase to scan more markets)
2. Spread threshold: `POLY_MIN_SPREAD_THRESHOLD` (lower to find more opps)
3. LLM enabled: `POLY_USE_LLM_DETECTION=true` (finds more cross-market opps)
4. Paper trading: `POLY_PAPER_TRADING=true` (simulates trades without execution)

### Trades Not Executing

**Check**:
1. Approvals: USDC permit + CTF approval (check `approvalStatus` in state)
2. Balance: USDC balance >= trade cost * 1.05
3. Exposure limits: Current exposure < `POLY_MAX_TOTAL_EXPOSURE_USD`
4. Min profit: Trades meet `POLY_MIN_PROFIT_USD` threshold
5. Manual approval: `POLY_MANUAL_APPROVAL=false` for auto-execution

### LLM Detection Timeout

**Check**:
1. Market limit: `POLY_LLM_MAX_MARKETS` (reduce from 25 to 15)
2. Model: `POLY_LLM_MODEL=gpt-4o-mini` (faster than gpt-4o)
3. Timeout: 120s built-in, may need faster model or fewer markets

### Position Sync Not Working

**Check**:
1. Wallet address: `POLY_USER_WALLET_ADDRESS` must be set
2. API access: Polymarket Data API may have rate limits
3. Sync enabled: `POLY_SYNC_POSITIONS=true`
4. Frequency: Only syncs every 5th cycle

---

## Performance Optimization

### Reduce Cycle Time

1. Lower market count: `POLY_MAX_MARKETS=25`
2. Disable LLM: `POLY_USE_LLM_DETECTION=false`
3. Use pattern matching only (faster, deterministic)

### Reduce API Costs

1. Use LLM selectively: Only enable for specific market types
2. Smaller LLM model: `POLY_LLM_MODEL=gpt-4o-mini` (~50% cheaper)
3. Reduce LLM market limit: `POLY_LLM_MAX_MARKETS=15`

### Increase Opportunity Detection

1. Enable LLM: `POLY_USE_LLM_DETECTION=true`
2. Increase market count: `POLY_MAX_MARKETS=100`
3. Lower thresholds: `POLY_MIN_SPREAD_THRESHOLD=0.01`
4. Execute all opportunities: `POLY_EXECUTE_ALL_OPPORTUNITIES=true`

---

For detailed architecture, strategy, and workflow documentation, see:
- [01-architecture-overview.md](./01-architecture-overview.md)
- [02-strategy-deep-dive.md](./02-strategy-deep-dive.md)
- [03-langgraph-workflow.md](./03-langgraph-workflow.md)
- [strategy-overview.md](./strategy-overview.md)
