name: Release Packages

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Comma separated package overrides (agent-node, registry)'
        required: false
        type: string
  push:
    branches:
      - main
      - next
    paths:
      - 'typescript/lib/agent-node/**'
      - 'typescript/onchain-actions-plugins/registry/**'
      - 'typescript/scripts/**'
      - 'typescript/release/**'
      - 'typescript/.multi-releaserc.cjs'
      - '.github/workflows/release.yml'

permissions:
  contents: write

jobs:
  prepare:
    name: Detect release targets
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: typescript
    outputs:
      has_changes: ${{ steps.targets.outputs.has_changes }}
      matrix: ${{ steps.targets.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Determine release targets
        id: targets
        env:
          RELEASE_PACKAGE_OVERRIDE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.packages || '' }}
        run: |
          node ./scripts/detect-release-targets.mjs --output release-targets.json
          echo "matrix=$(jq -c '.matrix' release-targets.json)" >> "$GITHUB_OUTPUT"
          echo "has_changes=$(jq -r '((.selected | length) > 0)|tostring' release-targets.json)" >> "$GITHUB_OUTPUT"

  release:
    name: Publish ${{ matrix.package.packageName }}
    needs: prepare
    if: needs.prepare.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.prepare.outputs.matrix) }}
    defaults:
      run:
        working-directory: typescript
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fetch semantic-release notes
        run: git fetch origin refs/notes/semantic-release:refs/notes/semantic-release || true
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Build agent-node
        if: matrix.package.id == 'agent-node'
        run: pnpm --filter @emberai/agent-node build
      - name: Test agent-node
        if: matrix.package.id == 'agent-node'
        run: pnpm --filter @emberai/agent-node test:ci
      - name: Build registry
        if: matrix.package.id == 'registry'
        run: pnpm --filter @emberai/onchain-actions-registry build
      - name: Prepare npm publish folder
        if: matrix.package.id == 'registry'
        run: node scripts/prepare-npm-publish.mjs
      - name: Run multi-semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          pnpm release -- --packages "${{ matrix.package.packageJson }}" --summary-file "release-summary-${{ matrix.package.id }}.json"
      - name: Upload release summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-summary-${{ matrix.package.id }}
          path: typescript/release-summary-${{ matrix.package.id }}.json
          if-no-files-found: warn
      - name: Push semantic-release notes
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: git push origin refs/notes/semantic-release
