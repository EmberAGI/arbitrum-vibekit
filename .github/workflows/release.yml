name: Release Packages

on:
  workflow_dispatch:
    inputs:
      packages:
        description: 'Comma separated package overrides (agent-node, registry)'
        required: false
        type: string
  push:
    branches:
      - main
      - next
    paths:
      - 'typescript/lib/agent-node/**'
      - 'typescript/onchain-actions-plugins/registry/**'
      - 'typescript/scripts/**'
      - 'typescript/release/**'
      - 'typescript/.multi-releaserc.cjs'
      - '.github/workflows/release.yml'

permissions:
  contents: write

jobs:
  prepare:
    name: Detect release targets
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: typescript
    outputs:
      has_changes: ${{ steps.targets.outputs.has_changes }}
      matrix: ${{ steps.targets.outputs.matrix }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Determine release targets
        id: targets
        env:
          RELEASE_PACKAGE_OVERRIDE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.packages || '' }}
        run: |
          node ./scripts/detect-release-targets.mjs --output release-targets.json
          echo "matrix=$(jq -c '.matrix' release-targets.json)" >> "$GITHUB_OUTPUT"
          echo "has_changes=$(jq -r '((.selected | length) > 0)|tostring' release-targets.json)" >> "$GITHUB_OUTPUT"

  release:
    name: Publish ${{ matrix.package.packageName }}
    needs: prepare
    if: needs.prepare.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.prepare.outputs.matrix) }}
    defaults:
      run:
        working-directory: typescript
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Setup test environment
        if: matrix.package.id == 'agent-node'
        working-directory: typescript/lib/agent-node
        run: cp .env.test.example .env.test
      - name: Build agent-node
        if: matrix.package.id == 'agent-node'
        run: pnpm --filter @emberai/agent-node build
      - name: Test agent-node
        if: matrix.package.id == 'agent-node'
        run: pnpm --filter @emberai/agent-node test:ci
      - name: Build registry
        if: matrix.package.id == 'registry'
        run: pnpm --filter @emberai/onchain-actions-registry build
      - name: Prepare npm publish folder
        if: matrix.package.id == 'registry'
        run: node scripts/prepare-npm-publish.mjs
      - name: Run multi-semantic-release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          pnpm release -- --packages "${{ matrix.package.packageJson }}" --summary-file "release-summary-${{ matrix.package.id }}.json"
      - name: Upload release summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: release-summary-${{ matrix.package.id }}
          path: typescript/release-summary-${{ matrix.package.id }}.json
          if-no-files-found: warn

  sync-next:
    name: Sync next branch
    needs:
      - prepare
      - release
    if: github.ref == 'refs/heads/main' && (needs.release.result == 'success' || needs.release.result == 'skipped')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Fast-forward next to main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git fetch origin next
          current_next="$(git rev-parse --verify origin/next)"
          head_sha="$(git rev-parse HEAD)"

          if [ "$current_next" = "$head_sha" ]; then
            echo "next is already up to date with main"
            exit 0
          fi

          if git merge-base --is-ancestor "$current_next" "$head_sha"; then
            echo "Fast-forwarding next to $head_sha"
            git push origin "$head_sha":next
          else
            echo "::warning::origin/next has diverged from main; skipping auto-sync. Please merge main into next manually."
          fi
