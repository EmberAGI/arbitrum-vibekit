name: AI-Powered Mintlify Docs Sync

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, edited]

jobs:
  sync-docs:
    if: |
      (github.event_name == 'issue_comment' && github.event.issue.pull_request != '' && contains(github.event.comment.body, '@docs-update')) ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.body, '@docs-update'))
    runs-on: ubuntu-latest
    environment: ci
    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            let prNumber, prData;

            if (context.eventName === 'issue_comment') {
              prNumber = context.issue.number;
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              prData = pr;
            } else {
              // pull_request event
              prData = context.payload.pull_request;
            }

            core.setOutput('pr_number', prData.number);
            core.setOutput('pr_title', prData.title);
            core.setOutput('pr_body', prData.body || '');
            core.setOutput('head_sha', prData.head.sha);
            core.setOutput('base_ref', prData.base.ref);

      - name: Checkout the PR head sha
        uses: actions/checkout@v4
        with:
          # Use full history so git can find a merge base with the base branch
          ref: ${{ steps.pr.outputs.head_sha }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Install dependencies
        working-directory: ./typescript
        run: pnpm install --frozen-lockfile

      - name: Checkout Mintlify repo
        uses: actions/checkout@v4
        with:
          repository: EmberAGI/ember_docs
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: ember_docs
          fetch-depth: 0

      - name: Verify Mintlify repo checkout
        run: |
          if [ ! -d "ember_docs" ]; then
            echo "âŒ ember_docs directory not found after checkout!"
            echo "This likely means the DOCS_SYNC_TOKEN doesn't have access to EmberAGI/ember_docs"
            exit 1
          fi
          echo "âœ… ember_docs directory exists"
          ls -la ember_docs/ | head -20

      - name: AI-Powered Documentation Analysis and Update
        working-directory: ./typescript
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          node scripts/sync-mintlify-docs.mjs \
            "${{ steps.pr.outputs.pr_number }}" \
            "${{ steps.pr.outputs.pr_title }}" \
            "${{ steps.pr.outputs.pr_body }}"

      - name: Read sync summary
        id: summary
        run: |
          if [ -f mintlify-sync-summary.json ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            SUMMARY=$(cat mintlify-sync-summary.json | jq -r '.summary')
            ANALYSIS=$(cat mintlify-sync-summary.json | jq -r '.analysis')
            FILES=$(cat mintlify-sync-summary.json | jq -r '.updatedFiles | join(", ")')
            echo "summary<<EOF" >> $GITHUB_OUTPUT
            echo "$SUMMARY" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "analysis<<EOF" >> $GITHUB_OUTPUT
            echo "$ANALYSIS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request in Mintlify repo
        if: steps.summary.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.DOCS_SYNC_TOKEN }}
          path: ember_docs
          commit-message: "docs: AI-powered sync from Vibekit PR #${{ steps.pr.outputs.pr_number }}"
          branch: docs-sync-${{ github.run_id }}
          title: "ğŸ¤– AI Docs Sync from Vibekit PR #${{ steps.pr.outputs.pr_number }}"
          body: |
            ## ğŸ¤– AI-Powered Documentation Sync

            Triggered by **@docs-update** on Vibekit PR [#${{ steps.pr.outputs.pr_number }}](https://github.com/${{ github.repository }}/pull/${{ steps.pr.outputs.pr_number }})

            ### ğŸ“Š Analysis
            ${{ steps.summary.outputs.analysis }}

            ### ğŸ“ Summary
            ${{ steps.summary.outputs.summary }}

            ### ğŸ“„ Updated Files
            ${{ steps.summary.outputs.files }}

            ---

            **Note:** This PR was automatically generated by AI analysis. Please review all changes carefully before merging.
          base: main
