name: Automate Documentation

on:
  push:
    branches-ignore: [main, master, next]

jobs:
  auto-docs:
    runs-on: ubuntu-latest
    environment: ci
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Need at least 2 commits for git diff

      - name: Detect changed files
        id: changes
        uses: tj-actions/changed-files@v45
        with:
          files: |
            typescript/**
            !typescript/examples/**
            !typescript/test-utils/**
            !typescript/**/__tests__/**
            !**/*.spec.ts

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: |
          cd typescript
          npm install -g pnpm
          pnpm install --frozen-lockfile

      - name: Generate AI-powered documentation
        run: |
          cd typescript
          node scripts/generateDocs.mjs '${{ steps.changes.outputs.all_changed_files }}'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

      - name: Format generated docs
        run: |
          cd typescript
          # Format documentation files (excluding main README)
          find . -name "*.md" -type f ! -path "./README.md" ! -path "../README.md" -exec npx prettier --write {} + 2>/dev/null || true

      - name: Create documentation PR
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto/docs-update
          commit-message: "chore(docs): auto-update from recent TypeScript changes"
          title: "ðŸ¤– Auto Documentation Update"
          body: |
            This PR contains automatically generated documentation from recent code changes.
            - Generated by an AI agent using OpenRouter or OpenAI.
            - Review for accuracy before merging.
